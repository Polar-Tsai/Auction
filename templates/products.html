{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block content %}
<!-- Include Polling CSS -->
<link rel="stylesheet" href="{% static 'css/polling-animations.css' %}">

<!-- Include Polling JavaScript -->
<script src="{% static 'js/polling.js' %}"></script>

<div class="mb-8">
  <!-- Session Warning (if logged in) -->
  {% if employee %}
  <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm text-yellow-700">
          {% trans "æ‚¨ç›®å‰ä»¥å·¥è™Ÿ" %} <strong>{{ employee.employeeId }}</strong> {% trans "ç™»å…¥ï¼Œè«‹ç¢ºèªæ˜¯æ‚¨æœ¬äººæ“ä½œã€‚å†’ç”¨ä»–äººå·¥è™Ÿå°‡é•åéŠæˆ²è¦å®šã€‚" %}
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Tabs -->
  <div class="flex space-x-8 border-b border-gray-300 mb-6">
    <button onclick="filterProducts('Open')" id="tab-Open" class="tab-btn px-2 py-2 text-blue-600 font-bold border-b-2 border-blue-600 focus:outline-none transition-colors">
      {% trans "é€²è¡Œä¸­" %} <span class="count-badge" id="count-Open">({{ status_counts.Open }})</span>
    </button>
    <button onclick="filterProducts('Closed')" id="tab-Closed" class="tab-btn px-2 py-2 text-gray-600 hover:text-gray-800 focus:outline-none transition-colors border-b-2 border-transparent">
      {% trans "å·²çµæ¨™" %} <span class="count-badge" id="count-Closed">({{ status_counts.Closed }})</span>
    </button>
    <button onclick="filterProducts('Upcoming')" id="tab-Upcoming" class="tab-btn px-2 py-2 text-gray-600 hover:text-gray-800 focus:outline-none transition-colors border-b-2 border-transparent">
      {% trans "å°šæœªé–‹å§‹" %} <span class="count-badge" id="count-Upcoming">({{ status_counts.Upcoming }})</span>
    </button>
  </div>
  
  <!-- Products Grid -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="products-grid">
    {% for p in products %}
    <div class="product-card group bg-gray-100 rounded-lg shadow-sm hover:shadow-md transition overflow-hidden border border-gray-200" 
         data-product-id="{{ p.id }}"
         data-status="{{ p.status }}"
         data-price="{{ p.current_price }}"
         data-bids-count="{{ p.bids_count|default:0 }}"
         data-end="{{ p.end_time }}" 
         data-start="{{ p.start_time }}"
         data-winner="{{ p.winner_name|default:'' }}">
       
       <!-- Image Section (Sky/Hill placeholder aesthetics if no image) -->
       <a href="{% url 'auctions:product_detail' p.id %}" class="block h-48 relative bg-blue-200 overflow-hidden cursor-pointer">
         {% if p.main_image %}
            <img src="{{ p.main_image }}" alt="{{ p.name }}" class="w-full h-full object-cover">
         {% else %}
            <!-- CSS Landscape Placeholder -->
            <div class="absolute inset-0 bg-blue-200">
                <!-- Clouds (simple circles) -->
                <div class="absolute top-8 left-1/4 w-16 h-16 bg-white rounded-full opacity-80 blur-sm"></div>
                <div class="absolute top-6 left-1/3 w-20 h-20 bg-white rounded-full opacity-80 blur-sm"></div>
                <div class="absolute top-10 right-1/4 w-12 h-12 bg-white rounded-full opacity-60 blur-sm"></div>
                <!-- Hills -->
                <div class="absolute bottom-0 w-full h-1/3 bg-green-600 rounded-t-[50%] scale-150 translate-y-2"></div>
                <div class="absolute bottom-0 w-full h-1/4 bg-green-700 rounded-t-[40%] scale-125 translate-x-10 translate-y-4"></div>
            </div>
         {% endif %}
       </a>
       
       <!-- Info Body -->
       <div class="p-4">
         <a href="{% url 'auctions:product_detail' p.id %}" class="block hover:underline">
             <h3 class="font-bold text-lg text-gray-900 mb-1 truncate" title="{{ p.name }}">{{ p.name }}</h3>
         </a>
         
         <div class="mb-1">
           <div class="text-xs text-gray-500">{% trans "ç›®å‰åƒ¹æ ¼" %}</div>
           <div class="flex justify-between items-baseline">
             <span class="text-2xl font-bold text-blue-600 price-display" data-product-id="{{ p.id }}">
                <!-- Simple comma formatting handled by intcomma if available, else standard -->
                ${{ p.current_price|floatformat:0 }}
             </span>
             <span class="text-xs text-gray-500 bids-count-display" data-product-id="{{ p.id }}">{{ p.bids_count|default:0 }}{% trans "æ¬¡å‡ºåƒ¹" %}</span>
           </div>
         </div>

         
         <!-- Timer / Status Text -->
         <div class="flex items-center text-sm text-gray-700 mb-4 h-6">
            <span class="mr-1 opacity-70">ğŸ•’</span>
            <span class="countdown-timer text-xs font-medium">---</span>
         </div>
         
         <!-- Highest Bidder / Winner Information -->
         <div class="winner-info mb-3" data-product-id="{{ p.id }}">
           {% if p.status == 'Closed' or p.status == 'Unsold' or p.status == 'Ended' %}
             <!-- For closed items: show winner name -->
             {% if p.winner_name %}
               <div class="text-sm text-green-700 font-semibold flex items-center">
                 <span class="mr-1">ğŸ†</span>
                 <span>{% trans "å¾—æ¨™è€…" %}: {{ p.winner_name }}</span>
               </div>
             {% else %}
               <div class="text-sm text-gray-500 flex items-center">
                 <span class="mr-1">â„¹ï¸</span>
                 <span>{% trans "ç„¡äººå‡ºåƒ¹" %}</span>
               </div>
             {% endif %}
           {% elif p.status == 'Open' %}
             <!-- For open items: show highest bidder ID (å·¥è™Ÿ) -->
             {% if p.highest_bidder_id %}
               <div class="text-sm text-blue-600 font-medium flex items-center highest-bidder-display">
                 <span class="mr-1">ğŸ‘¤</span>
                 <span>{% trans "æœ€é«˜å‡ºåƒ¹" %}: {{ p.highest_bidder_id }}</span>
               </div>
             {% else %}
               <div class="text-sm text-gray-400 flex items-center">
                 <span class="mr-1">ğŸ’¤</span>
                 <span>{% trans "ç­‰å¾…é¦–æ¬¡å‡ºåƒ¹" %}</span>
               </div>
             {% endif %}
           {% endif %}
         </div>


         
         <!-- Action Button -->
         <div class="text-center">
           {% if p.status == 'Open' %}
             <a href="{% url 'auctions:product_detail' p.id %}" class="block w-full py-2 bg-gradient-to-b from-yellow-300 to-yellow-500 hover:from-yellow-400 hover:to-yellow-600 text-black font-bold rounded shadow-sm border border-yellow-600 text-sm">
               {% trans "å‡ºåƒ¹" %}
             </a>
           {% elif p.status == 'Upcoming' %}
             <button disabled class="block w-full py-2 bg-gray-300 text-gray-600 font-bold rounded shadow-sm border border-gray-400 cursor-not-allowed text-sm">
               {% trans "å°šæœªé–‹æ¨™" %}
             </button>
           {% else %}
             <button disabled class="block w-full py-2 bg-gray-300 text-gray-600 font-bold rounded shadow-sm border border-gray-400 cursor-not-allowed text-sm">
               {% trans "å·²çµæ¨™" %}
             </button>
           {% endif %}
         </div>
       </div>
    </div>
    {% empty %}
    <div class="col-span-full text-center py-12 text-gray-500">
      {% trans "ç›®å‰æ²’æœ‰å•†å“" %}
    </div>
    {% endfor %}
  </div>
</div>

<script>
  // Translation strings from Django
  const i18n = {
    hour: "{% trans 'æ™‚' %}",
    minute: "{% trans 'åˆ†' %}",
    second: "{% trans 'ç§’' %}",
    end: "{% trans 'çµæŸ' %}",
    start: "{% trans 'é–‹å§‹' %}",
    ended: "{% trans 'å·²çµæŸ' %}",
    starting: "{% trans 'å³å°‡é–‹å§‹' %}"
  };

  function filterProducts(status) {
    // Update Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('text-blue-600', 'font-bold', 'border-blue-600');
      btn.classList.add('text-gray-600', 'border-transparent');
    });
    const activeBtn = document.getElementById('tab-' + status);
    if(activeBtn) {
      activeBtn.classList.remove('text-gray-600', 'border-transparent');
      activeBtn.classList.add('text-blue-600', 'font-bold', 'border-blue-600');
    }

    // Filter Grid
    const cards = document.querySelectorAll('.product-card');
    let visibleCount = 0;
    cards.forEach(card => {
      const cardStatus = card.getAttribute('data-status');
      
      let show = false;
      if (status === 'Closed') {
         show = (cardStatus !== 'Open' && cardStatus !== 'Upcoming');
      } else {
         show = (cardStatus === status);
      }
      
      card.style.display = show ? 'block' : 'none';
      if(show) visibleCount++;
    });
  }

  function updateTimers() {
    const cards = document.querySelectorAll('.product-card');
    const now = new Date().getTime();

    cards.forEach(card => {
      const status = card.getAttribute('data-status');
      const endTimeStr = card.getAttribute('data-end');
      const startTimeStr = card.getAttribute('data-start');
      const timerEl = card.querySelector('.countdown-timer');
      
      if (!timerEl) return;

      if (status === 'Open' && endTimeStr) {
        const end = new Date(endTimeStr).getTime();
        const dist = end - now;
        if (dist < 0) {
          timerEl.innerText = i18n.ended;
        } else {
           const h = Math.floor(dist / (1000 * 60 * 60));
           const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
           const s = Math.floor((dist % (1000 * 60)) / 1000);
           timerEl.innerText = `${h}${i18n.hour}${m}${i18n.minute}${s}${i18n.second}${i18n.end}`;
        }
      } else if (status === 'Upcoming' && startTimeStr) {
        const start = new Date(startTimeStr).getTime();
        const dist = start - now;
        if (dist < 0) {
             timerEl.innerText = i18n.starting;
        } else {
           const h = Math.floor(dist / (1000 * 60 * 60));
           const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
           const s = Math.floor((dist % (1000 * 60)) / 1000);
           timerEl.innerText = `${h}${i18n.hour}${m}${i18n.minute}${s}${i18n.second}${i18n.start}`;
        }
      } else {
        timerEl.innerText = '---';
      }
    });
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    // Set i18n strings for polling system
    window.setPollingI18n({
      winner: "{% trans 'å¾—æ¨™è€…' %}",
      noBids: "{% trans 'ç„¡äººå‡ºåƒ¹' %}"
    });

    // Initialize product list poller
    const poller = new ProductListPoller();
    poller.start();

    // Setup Page Visibility API
    setupVisibilityHandling(poller);

    // Initialize existing functions
    filterProducts('Open'); // Default to Open
    setInterval(updateTimers, 1000);
    updateTimers();

    console.log('âœ… Product list page initialized with real-time polling');
  });
</script>
{% endblock %}