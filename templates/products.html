{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load auction_extras %}

{% block content %}
<!-- Include Polling CSS -->
<link rel="stylesheet" href="{% static 'css/polling-animations.css' %}">

<!-- Include Polling JavaScript -->
<script src="{% static 'js/polling.js' %}"></script>

<div class="mb-8">
  <!-- Session Warning (if logged in) -->
  {% if employee %}
  <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm text-yellow-700">
          {% trans "您目前以工號" %} <strong>{{ employee.employeeId }}</strong> {% trans "登入，請確認是您本人操作。冒用他人工號將違反遊戲規定。" %}
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Tabs -->
  <div class="flex space-x-8 border-b border-gray-300 mb-6">
    <button onclick="filterProducts('Open')" id="tab-Open" class="tab-btn px-2 py-2 font-bold border-b-2 focus:outline-none transition-colors" style="color: #1E40AF; border-bottom-color: #1E40AF;">
      {% trans "進行中" %} <span class="count-badge" id="count-Open">({{ status_counts.Open }})</span>
    </button>
    <button onclick="filterProducts('Closed')" id="tab-Closed" class="tab-btn px-2 py-2 text-gray-600 hover:text-gray-800 focus:outline-none transition-colors border-b-2 border-transparent">
      {% trans "已結標" %} <span class="count-badge" id="count-Closed">({{ status_counts.Closed }})</span>
    </button>
    <button onclick="filterProducts('Upcoming')" id="tab-Upcoming" class="tab-btn px-2 py-2 text-gray-600 hover:text-gray-800 focus:outline-none transition-colors border-b-2 border-transparent">
      {% trans "尚未開始" %} <span class="count-badge" id="count-Upcoming">({{ status_counts.Upcoming }})</span>
    </button>
  </div>
  
  <!-- Products Grid -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="products-grid">
    {% for p in products %}
    <div class="product-card group bg-white rounded-lg shadow-md hover:shadow-lg transition overflow-hidden border border-gray-200" 
         data-product-id="{{ p.id }}"
         data-status="{{ p.status }}"
         data-price="{{ p.current_price }}"
         data-bids-count="{{ p.bids_count|default:0 }}"
         data-end="{{ p.end_time|date:'c' }}" 
         data-start="{{ p.start_time|date:'c' }}"
         data-winner="{{ p.winner_name|default:'' }}">
       
       <!-- Image Section (Sky/Hill placeholder aesthetics if no image) -->
       <a href="{% url 'auctions:product_detail' p.id %}" class="block h-48 relative bg-blue-200 overflow-hidden cursor-pointer">
         {% if p.main_image %}
            <img src="{{ p.main_image }}" alt="{{ p.name }}" class="w-full h-full object-cover">
         {% else %}
            <!-- CSS Landscape Placeholder -->
            <div class="absolute inset-0 bg-blue-200">
                <!-- Clouds (simple circles) -->
                <div class="absolute top-8 left-1/4 w-16 h-16 bg-white rounded-full opacity-80 blur-sm"></div>
                <div class="absolute top-6 left-1/3 w-20 h-20 bg-white rounded-full opacity-80 blur-sm"></div>
                <div class="absolute top-10 right-1/4 w-12 h-12 bg-white rounded-full opacity-60 blur-sm"></div>
                <!-- Hills -->
                <div class="absolute bottom-0 w-full h-1/3 bg-green-600 rounded-t-[50%] scale-150 translate-y-2"></div>
                <div class="absolute bottom-0 w-full h-1/4 bg-green-700 rounded-t-[40%] scale-125 translate-x-10 translate-y-4"></div>
            </div>
         {% endif %}
       </a>
       
       <!-- Info Body -->
       <div class="p-4">
         <a href="{% url 'auctions:product_detail' p.id %}" class="block hover:underline">
             <h3 class="font-bold text-lg text-gray-900 mb-1 truncate" title="{{ p.name }}">
                {% if "," in p.name %}
                    {% with title_parts=p.name|split:"," %}
                        {% if LANGUAGE_CODE|slice:":2" == "zh" %}
                            {{ title_parts.0 }}
                        {% elif LANGUAGE_CODE == "id" and title_parts|length > 1 %}
                            {{ title_parts.1 }}
                        {% else %}
                            {{ title_parts.0 }}
                        {% endif %}
                    {% endwith %}
                {% else %}
                    {{ p.name }}
                {% endif %}
             </h3>
         </a>
         
         <div class="mb-1">
           <div class="text-xs text-gray-500">{% trans "目前價格" %}</div>
           <div class="flex justify-between items-baseline">
             <span class="text-2xl font-bold price-display" style="color: #1E40AF;" data-product-id="{{ p.id }}">
                <!-- Simple comma formatting handled by intcomma if available, else standard -->
                ${{ p.current_price|floatformat:0 }}
             </span>
             <span class="text-xs text-gray-500 bids-count-display" data-product-id="{{ p.id }}">{{ p.bids_count|default:0 }}{% trans "次出價" %}</span>
           </div>
         </div>

         
         <!-- Timer / Status Text -->
          <div class="flex items-center text-sm text-gray-700 mb-4 h-6">
             <svg class="w-4 h-4 mr-1.5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
             </svg>
             <span class="countdown-timer text-xs font-medium">---</span>
          </div>
         
         <!-- Highest Bidder / Winner Information -->
         <div class="winner-info mb-3" data-product-id="{{ p.id }}">
           {% if p.status == 'Closed' or p.status == 'Unsold' or p.status == 'Ended' %}
             <!-- For closed items: show winner name -->
              {% if p.winner_name %}
                <div class="text-sm text-green-700 font-semibold flex items-center">
                  <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                  </svg>
                  <span>{% trans "得標者" %}: {{ p.winner_name }}</span>
                </div>
              {% else %}
                <div class="text-sm text-gray-500 flex items-center">
                  <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <span>{% trans "無人出價" %}</span>
                </div>
             {% endif %}
           {% elif p.status == 'Open' %}
             <!-- For open items: show highest bidder ID (工號) -->
              {% if p.highest_bidder_id %}
                <div class="text-sm font-medium flex items-center highest-bidder-display" style="color: #1E40AF;">
                  <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  <span>{% trans "最高出價" %}: {{ p.highest_bidder_id }}</span>
                </div>
              {% else %}
                <div class="text-sm text-gray-400 flex items-center">
                  <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <span>{% trans "等待首次出價" %}</span>
                </div>
             {% endif %}
           {% endif %}
         </div>


         
         <!-- Action Button -->
         <div class="text-center">
            {% if p.status == 'Open' %}
              <a href="{% url 'auctions:product_detail' p.id %}" class="block w-full py-2.5 font-bold rounded-full shadow-md transition text-sm" style="background-color: #1E40AF; color: white;" onmouseover="this.style.backgroundColor='#1a3a9e'" onmouseout="this.style.backgroundColor='#1E40AF'">
                {% trans "出價" %}
              </a>
            {% elif p.status == 'Upcoming' %}
              <button disabled class="block w-full py-2.5 bg-white font-bold rounded-full cursor-not-allowed text-sm" style="border: 2px solid #9492a4; color: #9492a4;">
                {% trans "尚未開標" %}
              </button>
            {% else %}
              <button disabled class="block w-full py-2.5 font-bold rounded-full cursor-not-allowed text-sm" style="background-color: #9492a4; color: white;">
                {% trans "已結標" %}
              </button>
            {% endif %}
         </div>
       </div>
    </div>
    {% empty %}
    <div class="col-span-full text-center py-12 text-gray-500">
      {% trans "目前沒有商品" %}
    </div>
    {% endfor %}
  </div>
</div>

<script>
  // Translation strings from Django
  const i18n = {
    hour: "{% trans '時' %}",
    minute: "{% trans '分' %}",
    second: "{% trans '秒' %}",
    end: "{% trans '結束' %}",
    start: "{% trans '開始' %}",
    ended: "{% trans '已結束' %}",
    starting: "{% trans '即將開始' %}"
  };

  window.currentTab = 'Open'; // Default tab

  function filterProducts(status) {
    window.currentTab = status;
    // Update Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('font-bold');
      btn.classList.add('text-gray-600');
      btn.style.color = '';
      btn.style.borderBottomColor = 'transparent';
    });
    const activeBtn = document.getElementById('tab-' + status);
    if(activeBtn) {
      activeBtn.classList.remove('text-gray-600');
      activeBtn.classList.add('font-bold');
      activeBtn.style.color = '#1E40AF';
      activeBtn.style.borderBottomColor = '#1E40AF';
    }

    // Filter Grid
    const cards = document.querySelectorAll('.product-card');
    let visibleCount = 0;
    cards.forEach(card => {
      const cardStatus = card.getAttribute('data-status');
      
      let show = false;
      if (status === 'Closed') {
         show = (cardStatus !== 'Open' && cardStatus !== 'Upcoming');
      } else {
         show = (cardStatus === status);
      }
      
      card.style.display = show ? 'block' : 'none';
      if(show) visibleCount++;
    });
  }

  // Global helper for polling.js to refresh visibility
  window.refreshFilters = function() {
    filterProducts(window.currentTab);
  };

  function updateTimers() {
    const cards = document.querySelectorAll('.product-card');
    const now = (typeof ServerTime !== 'undefined') ? ServerTime.now() : Date.now();

    cards.forEach(card => {
      const status = card.getAttribute('data-status');
      const endTimeStr = card.getAttribute('data-end');
      const startTimeStr = card.getAttribute('data-start');
      const timerEl = card.querySelector('.countdown-timer');
      const timerRow = timerEl ? timerEl.parentElement : null;
      
      if (!timerEl || !timerRow) return;

      // Helper for 00 padding
      const pad = (num) => String(num).padStart(2, '0');

      if (status === 'Open' && endTimeStr) {
        timerRow.style.display = 'flex';
        const end = new Date(endTimeStr).getTime();
        const dist = end - now;
        if (dist < 0) {
          timerEl.innerText = i18n.ended;
        } else {
          const h = Math.floor(dist / (1000 * 60 * 60));
          const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
          const s = Math.floor((dist % (1000 * 60)) / 1000);
          timerEl.innerText = `${pad(h)}${i18n.hour}${pad(m)}${i18n.minute}${pad(s)}${i18n.second}${i18n.end}`;
        }
      } else if (status === 'Upcoming' && startTimeStr) {
        timerRow.style.display = 'flex';
        const start = new Date(startTimeStr).getTime();
        const dist = start - now;
        if (dist < 0) {
          timerEl.innerText = i18n.starting;
        } else {
          const h = Math.floor(dist / (1000 * 60 * 60));
          const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
          const s = Math.floor((dist % (1000 * 60)) / 1000);
          timerEl.innerText = `${pad(h)}${i18n.hour}${pad(m)}${i18n.minute}${pad(s)}${i18n.second}${i18n.start}`;
        }
      } else {
        // Hide entire row for Closed, Ends, Unsold
        timerRow.style.display = 'none';
        timerEl.innerText = '---';
      }
    });
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    // Set i18n strings for polling system
    window.setPollingI18n({
      winner: "{% trans '得標者' %}",
      noBids: "{% trans '無人出價' %}",
      bid: "{% trans '出價' %}",
      notStarted: "{% trans '尚未開標' %}",
      ended: "{% trans '已結標' %}",
      highestBid: "{% trans '最高出價' %}",
      waitingBid: "{% trans '等待首次出價' %}"
    });

    // Initialize product list poller
    const poller = new ProductListPoller();
    poller.start();

    // Setup Page Visibility API
    setupVisibilityHandling(poller);

    // Initialize existing functions
    filterProducts('Open'); // Default to Open
    setInterval(updateTimers, 1000);
    updateTimers();

    console.log('✅ Product list page initialized with real-time polling');
  });
</script>
{% endblock %}