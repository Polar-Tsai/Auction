{% extends 'base.html' %}
{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mb-12">
        <!-- Left: Image Section -->
        <div>
            <div class="bg-gray-100 rounded-lg aspect-square flex items-center justify-center text-gray-400 overflow-hidden mb-4 relative">
                 <!-- Status Badge Top Right overlay if needed, but mockup shows it in text area sort of, let's keep it here or move it? Mockup has "ç«¶æ¨™ä¸­" top right of page? No, top right of info area. -->
                {% if product.image_url %}
                     <img src="{{ product.image_url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                {% else %}
                     <span class="text-6xl">ğŸ“·</span>
                {% endif %}
            </div>
            <!-- Thumbnails -->
            <div class="grid grid-cols-3 gap-4">
                <div class="aspect-square bg-gray-100 rounded border-2 border-blue-600 overflow-hidden">
                    {% if product.image_url %}<img src="{{ product.image_url }}" class="w-full h-full object-cover">{% endif %}
                </div>
                <!-- Placeholders -->
                <div class="aspect-square bg-gray-100 rounded overflow-hidden opacity-50">
                    {% if product.image_url %}<img src="{{ product.image_url }}" class="w-full h-full object-cover">{% endif %}
                </div>
                <div class="aspect-square bg-gray-100 rounded overflow-hidden opacity-50">
                    {% if product.image_url %}<img src="{{ product.image_url }}" class="w-full h-full object-cover">{% endif %}
                </div>
            </div>
        </div>

        <!-- Right: Info Section -->
        <div class="flex flex-col">
            <div class="mb-6 relative">
                 <!-- Status Badge top right of this col -->
                 <span id="status-display" class="absolute top-0 right-0 px-3 py-1 rounded-full text-sm font-medium
                    {% if product.status == 'Open' %}bg-green-100 text-green-800
                    {% elif product.status == 'Upcoming' %}bg-blue-100 text-blue-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {% if product.status == 'Open' %}ç«¶æ¨™ä¸­
                    {% elif product.status == 'Upcoming' %}å³å°‡é–‹å§‹
                    {% elif product.status == 'Closed' %}å·²çµæŸ
                    {% elif product.status == 'Unsold' %}æµæ¨™
                    {% else %}{{ product.status }}{% endif %}
                </span>

                <h1 class="text-3xl font-bold text-gray-900 mb-6">æ‹è³£å“åç¨±</h1>
                
                <!-- Description -->
                <div class="flex items-start mb-6">
                    <span class="text-gray-900 font-bold whitespace-nowrap mr-8">AI æè¿°</span>
                    <p class="text-gray-700 leading-relaxed max-w-lg">
                        {{ product.description|default:"è¶…ç¨€æœ‰ 2018 Topps Diamond Icons æ—¥æœ¬å‚³å¥‡ éˆ´æœ¨ä¸€æœ— æ¾äº•ç§€å–œ ç´…ç‰ˆ é›™äººç°½åå¡ é™é‡ 2/5 ç´ç´„æ´‹åŸº åäººå ‚" }}
                    </p>
                </div>

                <!-- Price Row -->
                <div class="flex items-center mb-2">
                    <span class="text-gray-900 font-bold whitespace-nowrap mr-8">ç›®å‰åƒ¹æ ¼</span>
                    <div class="flex items-baseline gap-4">
                        <span class="text-3xl font-bold text-blue-600">
                            $<span id="current-price">{{ product.current_price|default:product.start_price }}</span>
                        </span>
                        <a href="#history" class="text-blue-500 underline text-sm"><span id="bids-count">{{ product.bids_count|default:0 }}</span>æ¬¡å‡ºåƒ¹</a>
                    </div>
                </div>

                <!-- Highest Bidder Row -->
                <div class="flex items-center mb-6">
                    <span class="text-gray-900 font-bold whitespace-nowrap mr-6">æœ€é«˜å‡ºåƒ¹è€…</span>
                    <span class="text-gray-900 font-medium">
                        {{ product.highest_bidder_id|default:"---" }}
                    </span>
                </div>

                <!-- Timer -->
                <div class="flex items-center text-gray-800 mb-8">
                     <!-- Bold Clock Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="countdown-text" class="text-lg font-medium">9æ™‚1åˆ†51ç§’çµæŸ</span> <!-- Will be JS updated -->
                </div>

                <!-- Bidding Area -->
                <div class="bg-gray-200 p-6 rounded-lg flex items-center gap-4">
                    {% if employee %}
                        <input type="number" id="bid-amount" class="flex-1 bg-white border-0 py-3 px-4 outline-none shadow-sm text-center text-gray-600 rounded" placeholder="è«‹è¼¸å…¥å‡ºåƒ¹é‡‘é¡" />
                        <button onclick="placeBid()" class="w-40 bg-gradient-to-b from-yellow-300 to-yellow-500 hover:from-yellow-400 hover:to-yellow-600 text-black font-bold py-3 rounded shadow-md border border-yellow-600 transform transition active:scale-95">
                            å‡ºåƒ¹
                        </button>
                    {% else %}
                        <div class="w-full text-center text-gray-500">è«‹å…ˆç™»å…¥ä»¥å‡ºåƒ¹</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom: History Section -->
    <div class="border-t pt-8">
        <h3 class="text-xl font-bold mb-4 text-gray-800">å‡ºåƒ¹æ­·å²è¨˜éŒ„ (æœ€æ–° 10 ç­†)</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-black text-white text-sm uppercase">
                    <tr>
                        <th class="p-4 text-center">å‡ºåƒ¹è€…</th>
                        <th class="p-4 text-center">å‡ºåƒ¹é‡‘é¡</th>
                        <th class="p-4 text-center">å‡ºåƒ¹æ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="bids-list" class="divide-y divide-gray-100">
                     <!-- Populated via JS -->
                     <tr><td colspan="3" class="p-4 text-center text-gray-500">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const productId = {{ product.id }};
const endTimeStr = "{{ product.end_time|date:'Y-m-d H:i:s' }}"; 
// Note: Django date string might format slightly differently depending on settings, 
// ensuring strict ISO-like for JS parsing is safer, but let's try standard JS parse first.
// Ideally use: product.end_time.isoformat if available, or just standard string.
// Given filter: date:"Y-m-d H:i:s" -> "2025-12-17 18:00:00" which JS Date() parses fine usually.

const REFRESH_INTERVAL = 3000;

function updateCountdown() {
    const el = document.getElementById('countdown-text');
    if (!el || !endTimeStr) return;
    
    const now = new Date().getTime();
    const end = new Date(endTimeStr.replace(/-/g, "/")).getTime(); // Replace - with / for better cross-browser compatibility
    const dist = end - now;
    
    if (dist < 0) {
        el.innerText = "å·²çµæŸ";
        return;
    }
    
    const h = Math.floor(dist / (1000 * 60 * 60));
    const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((dist % (1000 * 60)) / 1000);
    
    el.innerText = `${h}æ™‚${m}åˆ†${s}ç§’çµæŸ`;
}

function showToast(message, type='info') {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    const colorClass = type === 'error' ? 'bg-red-500' : 'bg-green-500';
    el.className = `${colorClass} text-white px-4 py-2 rounded shadow mb-2 transition-opacity duration-300 opacity-0 transform translate-x-4`;
    el.innerText = message;
    container.appendChild(el);
    requestAnimationFrame(() => {
        el.classList.remove('opacity-0', 'translate-x-4');
    });
    setTimeout(() => {
        el.classList.add('opacity-0', 'translate-x-4');
        setTimeout(() => el.remove(), 300);
    }, 3000);
}

async function placeBid() {
    const amountInput = document.getElementById('bid-amount');
    const amount = amountInput.value;
    
    if (!amount) {
        showToast('è«‹è¼¸å…¥é‡‘é¡', 'error');
        return;
    }

    try {
        const res = await fetch('/api/bids/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Add csrf token if not strictly disabled or handled by cookie, but views.py uses @csrf_exempt for now or we rely on cookie
                // 'X-CSRFToken': getCookie('csrftoken') 
            },
            body: JSON.stringify({ productId, amount })
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(`å‡ºåƒ¹æˆåŠŸï¼ç›®å‰åƒ¹æ ¼ ${data.newPrice}`, 'success');
            amountInput.value = '';
            pollData(); // Refresh immediately
        } else {
            showToast(data.message || 'å‡ºåƒ¹å¤±æ•—', 'error');
        }
    } catch (e) {
        console.error(e);
        showToast('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦', 'error');
    }
}

async function pollData() {
    try {
        const res = await fetch(`/api/products/${productId}/poll/`);
        const data = await res.json();
        if (data.success) {
            // Update Price
            const p = data.product;
            document.getElementById('current-price').innerText = p.current_price || p.start_price;
            document.getElementById('bids-count').innerText = p.bids_count || 0;
            
            // Update List
            const list = document.getElementById('bids-list');
            list.innerHTML = '';
            if (data.bids && data.bids.length > 0) {
                data.bids.forEach(bid => {
                    // Simple formatting
                    const d = new Date(bid.bid_timestamp);
                    const dateStr = d.toLocaleString('zh-TW');
                    list.innerHTML += `<tr class="hover:bg-gray-50 transition border-b">
                        <td class="p-4 text-center font-medium text-gray-700">${bid.bidder_id}</td>
                        <td class="p-4 text-center font-medium text-gray-900">$${parseInt(bid.amount).toLocaleString()}</td>
                        <td class="p-4 text-center text-gray-500 text-sm">${dateStr}</td>
                    </tr>`;
                });
            } else {
                list.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">ç›®å‰å°šç„¡å‡ºåƒ¹ï¼Œæˆç‚ºç¬¬ä¸€å€‹å‡ºåƒ¹è€…ï¼</td></tr>';
            }
        }
    } catch (e) {
        console.log('Poll failed', e);
    }
}

// Start polling
setInterval(pollData, REFRESH_INTERVAL);
setInterval(updateCountdown, 1000);
pollData(); // Initial load
updateCountdown();
</script>
{% endblock %}
