{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load auction_extras %}

{% block content %}
<!-- Include Polling CSS -->
<link rel="stylesheet" href="{% static 'css/polling-animations.css' %}">

<!-- Responsive Bid Area CSS -->
<style>
  /* Mobile: Floating bid area at bottom */
  @media (orientation: portrait) {
    #bid-area {
      position: fixed !important;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      border-radius: 1rem 1rem 0 0 !important;
      box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
      max-width: 100%;
      margin: 0 !important;
    }
    
    /* Add padding to content to prevent overlap */
    .max-w-6xl {
      padding-bottom: 200px !important;
    }
  }
  
  /* Desktop: Keep bid area in normal flow */
  @media (orientation: landscape) {
    #bid-area {
      position: static;
    }
  }
</style>

<!-- Include Polling JavaScript -->
<script src="{% static 'js/polling.js' %}"></script>

<div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mb-12">
        <!-- Left: Image Section -->
        <div>
            <div class="bg-gray-100 rounded-lg aspect-square flex items-center justify-center text-gray-400 overflow-hidden mb-4 relative">
                <!-- Main Image -->
                <img id="main-image" 
                     src="{% if images %}/data_photo/{{ product.id }}/{{ images.0 }}{% else %}{% endif %}" 
                     alt="{{ product.name }}" 
                     class="w-full h-full object-cover {% if not images %}hidden{% endif %}">
                {% if not images %}
                     <span class="text-6xl">ğŸ“·</span>
                {% endif %}
            </div>
            
            <!-- Thumbnails Carousel -->
            {% if images %}
            <div class="relative group mt-4 px-8">
                <!-- Left Button -->
                <button onclick="scrollThumbnails(-1)" id="carousel-left" class="absolute left-0 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 rounded-full p-1 shadow-md border border-gray-200 z-10 hidden transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>

                <!-- Carousel Viewport -->
                <div class="overflow-hidden -mx-2">
                    <div id="thumbnail-track" class="flex transition-transform duration-300 ease-out" style="transform: translateX(0%);">
                        {% for img in images %}
                        <div class="flex-none w-1/4 px-2 aspect-square cursor-pointer" 
                             onclick="updateMainImage('/data_photo/{{ product.id }}/{{ img }}')">
                            <div class="w-full h-full rounded border border-transparent hover:border-[#1E40AF] overflow-hidden bg-gray-100">
                                <img src="/data_photo/{{ product.id }}/{{ img }}" class="w-full h-full object-cover">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Right Button -->
                <button onclick="scrollThumbnails(1)" id="carousel-right" class="absolute right-0 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 rounded-full p-1 shadow-md border border-gray-200 z-10 hidden transition">
                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            {% endif %}
        </div>
        
        <script>
            let currentIndex = 0;
            const VISIBLE_COUNT = 4;
            const TOTAL_IMAGES = {{ images|length }};
            
            function updateMainImage(src) {
                const img = document.getElementById('main-image');
                img.src = src;
                img.classList.remove('hidden');
            }

            function scrollThumbnails(direction) {
                const track = document.getElementById('thumbnail-track');
                const leftBtn = document.getElementById('carousel-left');
                const rightBtn = document.getElementById('carousel-right');
                
                if (TOTAL_IMAGES <= VISIBLE_COUNT) return;

                const maxIndex = TOTAL_IMAGES - VISIBLE_COUNT;
                currentIndex += direction;
                
                if (currentIndex < 0) currentIndex = 0;
                if (currentIndex > maxIndex) currentIndex = maxIndex;

                const itemWidthPercent = 25;
                track.style.transform = `translateX(-${currentIndex * (100 / VISIBLE_COUNT)}%)`;

                updateButtons();
            }

            function updateButtons() {
                const leftBtn = document.getElementById('carousel-left');
                const rightBtn = document.getElementById('carousel-right');
                if(!leftBtn || !rightBtn) return;
                
                if (TOTAL_IMAGES <= VISIBLE_COUNT) {
                    leftBtn.classList.add('hidden');
                    rightBtn.classList.add('hidden');
                } else {
                    leftBtn.classList.remove('hidden');
                    rightBtn.classList.remove('hidden');
                    
                    if (currentIndex <= 0) leftBtn.classList.add('opacity-50', 'cursor-not-allowed'); 
                    else leftBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    if (currentIndex >= (TOTAL_IMAGES - VISIBLE_COUNT)) rightBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    else rightBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
            
            // Init buttons on load
            document.addEventListener('DOMContentLoaded', updateButtons);
        </script>

        <!-- Right: Info Section -->
        <div class="flex flex-col">
            <div class="mb-6 relative">
                 <!-- Status Badge above title -->
                 <div class="flex justify-start mb-3">
                     <span id="status-display" class="px-4 py-1.5 rounded-full text-sm font-bold shadow-sm inline-flex items-center gap-2
                        {% if product.status == 'Open' %}bg-green-50 text-green-700 border border-green-100
                        {% elif product.status == 'Upcoming' %}bg-blue-50 text-[#1E40AF] border border-blue-100{% endif %}"
                        {% if product.status == 'Upcoming' %}{% elif product.status == 'Closed' or product.status == 'Unsold' %}class="bg-gray-50 text-gray-600 border border-gray-100"{% endif %}>
                        <span class="w-2 h-2 rounded-full {% if product.status == 'Open' %}bg-green-500 animate-pulse{% elif product.status == 'Upcoming' %}bg-[#1E40AF]{% else %}bg-gray-400{% endif %}"></span>
                        {% if product.status == 'Open' %}{% trans "ç«¶æ¨™ä¸­" %}
                        {% elif product.status == 'Upcoming' %}{% trans "å³å°‡é–‹å§‹" %}
                        {% elif product.status == 'Closed' %}{% trans "å·²çµæŸ" %}
                        {% elif product.status == 'Unsold' %}{% trans "æµæ¨™" %}
                        {% else %}{{ product.status }}{% endif %}
                    </span>
                 </div>

                <!-- Bilingual Title Logic: Split by comma and filter by language -->
                <div class="mb-8">
                    {% if "," in product.name %}
                        {% with title_parts=product.name|split:"," %}
                            <h1 class="text-3xl font-bold text-gray-900 leading-tight">
                                {% if LANGUAGE_CODE|slice:":2" == "zh" %}
                                    {{ title_parts.0 }}
                                {% elif LANGUAGE_CODE == "id" and title_parts|length > 1 %}
                                    {{ title_parts.1 }}
                                {% else %}
                                    {{ title_parts.0 }}
                                {% endif %}
                            </h1>
                        {% endwith %}
                    {% else %}
                        <h1 class="text-3xl font-bold text-gray-900 leading-tight">{{ product.name }}</h1>
                    {% endif %}
                </div>
                
                <!-- Description: Split by language -->
                <div class="flex items-start mb-8 group">
                    <span class="text-gray-900 font-bold whitespace-nowrap mr-8 py-0.5 border-l-4 border-[#1E40AF] pl-3">{% trans "å•†å“æè¿°" %}</span>
                    <p class="text-gray-700 leading-relaxed text-base">
                        {% if "," in product.description %}
                            {% with desc_parts=product.description|split:"," %}
                                {% if LANGUAGE_CODE|slice:":2" == "zh" %}
                                    {{ desc_parts.0 }}
                                {% elif LANGUAGE_CODE == "id" and desc_parts|length > 1 %}
                                    {{ desc_parts.1 }}
                                {% else %}
                                    {{ desc_parts.0 }}
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            {{ product.description }}
                        {% endif %}
                    </p>
                </div>

                <!-- Price Row -->
                <div class="flex items-center mb-4 bg-gray-50 p-4 rounded-2xl border border-gray-100">
                    <span class="text-gray-900 font-bold whitespace-nowrap mr-8">{% trans "ç›®å‰åƒ¹æ ¼" %}</span>
                    <div class="flex items-baseline gap-4">
                        <span class="text-3xl font-black tracking-tight" style="color: #1E40AF;" data-price-display>
                            $<span id="current-price">{{ product.current_price|default:product.start_price }}</span>
                        </span>
                        <a href="#history" class="underline text-sm font-bold no-underline hover:underline transition" style="color: #1E40AF;" data-bids-count-display>
                            <span id="bids-count" class="bg-[#1E40AF] text-white px-2 py-0.5 rounded-full text-xs mr-1">{{ product.bids_count|default:0 }}</span>{% trans "æ¬¡å‡ºåƒ¹" %}
                        </a>
                    </div>
                </div>

                <!-- Highest Bidder Row -->
                <div class="flex items-center mb-8 px-4">
                    <span class="text-gray-500 font-bold text-sm whitespace-nowrap mr-6">{% trans "æœ€é«˜å‡ºåƒ¹è€…" %}</span>
                    <span class="text-gray-900 font-black text-lg" data-highest-bidder>
                        ---
                    </span>
                </div>

                <!-- Timer -->
                <div class="flex items-center text-gray-800 mb-8 bg-amber-50 rounded-xl px-4 py-3 border border-amber-100 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="countdown-text" class="text-lg font-black text-amber-900">---</span>
                </div>

                <!-- Bidding Area (Boxed Design) -->
                <div id="bid-area" class="{% if product.status == 'Open' %}bg-white border-2 border-gray-100{% else %}bg-gray-50 border border-gray-200{% endif %} shadow-2xl rounded-3xl overflow-hidden">
                    {% if employee %}
                        <!-- Floating Header / Status Bar -->
                        <div class="bg-gray-50/80 backdrop-blur-sm border-b border-gray-100 px-6 py-3 flex items-center justify-center gap-2 text-xs font-bold text-gray-500">
                             <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                             {% trans "å·¥è™Ÿ" %} {{ employee.employeeId }} - {{ employee.name }}
                        </div>

                        <div class="p-6">
                            {% if product.status == 'Open' %}
                                <!-- Increment Bidding UI -->
                                <div class="space-y-6">
                                    <div class="flex justify-between items-end">
                                        <div>
                                            <span class="text-[10px] uppercase tracking-widest text-gray-400 font-black">{% trans "ç•¶å‰åƒ¹æ ¼" %}</span>
                                            <div class="text-2xl font-black text-gray-900" id="current-price-display">${{ product.current_price|default:product.start_price }}</div>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-[10px] uppercase tracking-widest text-[#1E40AF] font-black">{% trans "ä¸‹æ¬¡å‡ºåƒ¹" %}</span>
                                            <div class="text-3xl font-black" style="color: #1E40AF;">
                                                {% if product.bids_count == 0 %}
                                                    $<span id="next-bid-amount">{{ product.start_price }}</span>
                                                {% else %}
                                                    $<span id="next-bid-amount">{{ product.current_price|default:product.start_price|add:bid_increment }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="text-[10px] font-bold text-gray-400">
                                                {% if product.bids_count == 0 %}({% trans "åº•åƒ¹" %}){% else %}(+${{ bid_increment }}){% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button onclick="placeBid()" class="w-full text-white font-black py-4 text-xl rounded-2xl shadow-xl shadow-blue-200/50 transform transition active:scale-[0.97] hover:brightness-110" style="background-color: #1E40AF;">
                                        {% if product.bids_count == 0 %}
                                            {% trans "å‡ºåƒ¹" %} ${{ product.start_price }}
                                        {% else %}
                                            {% trans "å‡ºåƒ¹" %} +${{ bid_increment }}
                                        {% endif %}
                                    </button>
                                    
                                    <p class="text-[10px] text-gray-400 text-center font-bold tracking-tight">{% trans "æ¯æ¬¡å‡ºåƒ¹å¢é‡ç‚ºåº•åƒ¹çš„ 1/10" %}</p>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <button class="w-full bg-gray-100 text-gray-400 border border-gray-200 font-black py-4 rounded-2xl shadow-sm cursor-not-allowed text-lg" disabled>
                                        {% if product.status == 'Upcoming' %}{% trans "å°šæœªé–‹å§‹" %}
                                        {% elif product.status == 'Closed' or product.status == 'Ended' %}{% trans "å·²çµæŸ" %}
                                        {% elif product.status == 'Unsold' %}{% trans "æµæ¨™" %}
                                        {% else %}{% trans "ç„¡æ³•å‡ºåƒ¹" %}{% endif %}
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="p-8 text-center bg-blue-50">
                            <a href="{% url 'auctions:login' %}" class="text-[#1E40AF] font-black hover:underline">{% trans "è«‹å…ˆç™»å…¥ä»¥å‡ºåƒ¹" %}</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom: History Section -->
    <div class="border-t pt-8">
        <h3 class="text-xl font-bold mb-4 text-gray-800">{% trans "å‡ºåƒ¹æ­·å²è¨˜éŒ„ (æœ€æ–° 10 ç­†)" %}</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-black text-white text-sm uppercase">
                    <tr>
                        <th class="p-4 text-center">{% trans "å‡ºåƒ¹è€…" %}</th>
                        <th class="p-4 text-center">{% trans "å‡ºåƒ¹é‡‘é¡" %}</th>
                        <th class="p-4 text-center">{% trans "å‡ºåƒ¹æ™‚é–“" %}</th>
                    </tr>
                </thead>
                <tbody id="bids-list" class="divide-y divide-gray-100" data-bid-history>
                     <!-- Populated via JS -->
                     <tr><td colspan="3" class="p-4 text-center text-gray-500">{% trans "è¼‰å…¥ä¸­..." %}</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- First Bid Confirmation Modal -->
<div id="firstBidModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none; z-index: 200;">
  <div class="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-xl">
    <div class="text-center mb-4">
      <!-- Blue i icon -->
      <div class="flex justify-center mb-3">
        <div class="w-16 h-16 rounded-full flex items-center justify-center" style="background-color: #1E40AF;">
          <span class="text-white text-4xl font-bold">i</span>
        </div>
      </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2">{% trans "é¦–æ¬¡å‡ºåƒ¹ç¢ºèª" %}</h3>
    </div>
    <p class="text-gray-700 text-sm mb-6 text-center leading-relaxed">
      {% trans "é€™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡åƒåŠ ç«¶æ¨™ï¼Œé»æ“Šç¢ºèªå³è¡¨ç¤ºæ‚¨åŒæ„åƒèˆ‡ç«¶æ¨™æ´»å‹•ã€‚ä¸€æ—¦ç¢ºèªå¾Œï¼Œæ‚¨çš„å‡ºåƒ¹å°‡æœƒè¢«è¨˜éŒ„ã€‚" %}
    </p>
    <div class="flex gap-3">
      <button id="cancelFirstBid" class="flex-1 py-2.5 border-2 border-gray-300 rounded-full font-bold text-gray-700 hover:bg-gray-50 transition">
        {% trans "å–æ¶ˆ" %}
      </button>
      <button id="confirmFirstBid" class="flex-1 py-2.5 rounded-full font-bold text-white transition" style="background-color: #1E40AF;" onmouseover="this.style.backgroundColor='#1a3a9e'" onmouseout="this.style.backgroundColor='#1E40AF'">
        {% trans "æˆ‘ç¢ºèªåƒåŠ " %}
      </button>
    </div>
  </div>
</div>

<script>
// Translation strings
const i18n = {
  hour: "{% trans 'æ™‚' %}",
  minute: "{% trans 'åˆ†' %}",
  second: "{% trans 'ç§’' %}",
  end: "{% trans 'çµæŸ' %}",
  start: "{% trans 'é–‹å§‹' %}",
  ended: "{% trans 'å·²çµæŸ' %}",
  pleaseEnterAmount: "{% trans 'è«‹è¼¸å…¥é‡‘é¡' %}",
  bidSuccess: "{% trans 'å‡ºåƒ¹æˆåŠŸï¼ç›®å‰åƒ¹æ ¼' %}",
  bidFailed: "{% trans 'å‡ºåƒ¹å¤±æ•—' %}",
  networkError: "{% trans 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦' %}",
  noBidsYet: "{% trans 'ç›®å‰å°šç„¡å‡ºåƒ¹ï¼Œæˆç‚ºç¬¬ä¸€å€‹å‡ºåƒ¹è€…ï¼' %}",
  timeExtended: "{% trans 'â° ç«¶æ¨™æ™‚é–“å·²å»¶é•·' %}"
};

const productId = {{ product.id }};
let endTimeStr = "{{ product.end_time|date:'c' }}";  // Use ISO 8601 format
const startTimeStr = "{{ product.start_time|date:'c' }}";
const productStatus = "{{ product.status }}";
const bidIncrement = {{ bid_increment }};  // Increment value from backend
const startPrice = {{ product.start_price }};  // Start price (åº•åƒ¹)
const REFRESH_INTERVAL = 1000;  // Poll every 1 second for real-time updates
let currentBidsCount = {{ product.bids_count|default:0 }};  // Track if there are any bids

function updateCountdown() {
    const el = document.getElementById('countdown-text');
    if (!el || !endTimeStr) return;
    
    const now = Date.now();
    const end = new Date(endTimeStr).getTime();
    const dist = end - now;
    
    if (dist < 0) {
        el.innerText = i18n.ended;
        
        // Disable UI immediately when time is up
        const statusEl = document.getElementById('status-display');
        if (statusEl) {
            statusEl.className = 'absolute top-0 right-0 px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800';
            statusEl.innerText = i18n.ended;
        }

        // Disable bidding area
        const bidButton = document.querySelector('button[onclick="placeBid()"]');
        if (bidButton) {
            bidButton.disabled = true;
            bidButton.className = "w-full bg-gray-300 text-gray-500 font-bold py-3 rounded shadow-md cursor-not-allowed";
            bidButton.innerText = i18n.ended;
            bidButton.onclick = null; // Remove handler
        }
        
        return;
    }
    
    const h = Math.floor(dist / (1000 * 60 * 60));
    const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((dist % (1000 * 60)) / 1000);
    
    // Determine if we're counting down to start or end
    const countdownAction = (productStatus === 'Upcoming') ? i18n.start : i18n.end;
    el.innerText = `${h}${i18n.hour}${m}${i18n.minute}${s}${i18n.second}å¾Œ${countdownAction}`;
}

function showToast(message, type='info') {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    const colorClass = type === 'error' ? 'bg-red-500' : 'bg-green-500';
    el.className = `${colorClass} text-white px-4 py-2 rounded shadow mb-2 transition-opacity duration-300 opacity-0 transform translate-x-4`;
    el.innerText = message;
    container.appendChild(el);
    requestAnimationFrame(() => {
        el.classList.remove('opacity-0', 'translate-x-4');
    });
    setTimeout(() => {
        el.classList.add('opacity-0', 'translate-x-4');
        setTimeout(() => el.remove(), 300);
    }, 3000);
}

// Modal control functions
function showFirstBidModal() {
    const modal = document.getElementById('firstBidModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
    }
}

function hideFirstBidModal() {
    const modal = document.getElementById('firstBidModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
    }
}

// Store the pending bid amount for when user confirms
let pendingBidAmount = null;

async function placeBid() {
    // Auto-calculate bid amount
    const currentPriceEl = document.getElementById('current-price-display');
    const currentPrice = parseInt(currentPriceEl?.textContent.replace('$', '').replace(',', '') || 0);
    
    // If this is the first bid (no bids yet), use start price; otherwise add increment
    const amount = currentBidsCount === 0 ? startPrice : (currentPrice + bidIncrement);
    
    // Disable button to prevent double-click
    const bidButton = event.target;
    if (bidButton.disabled) return;
    bidButton.disabled = true;
    
    try {
        // Check if this is user's first bid
        const langPrefix = window.location.pathname.split('/')[1];
        const checkRes = await fetch(`/${langPrefix}/api/check-first-bid/`);
        const checkData = await checkRes.json();
        
        if (checkData.success && checkData.is_first_bid) {
            // This is the user's first bid - show confirmation modal
            pendingBidAmount = amount;
            showFirstBidModal();
            bidButton.disabled = false;  // Re-enable button since we're showing modal
            return;
        }
        
        // Not first bid or check failed - proceed with bid directly
        await submitBid(amount, bidButton);
        
    } catch (e) {
        console.error('Error checking first bid:', e);
        // If check fails, proceed with bid anyway
        await submitBid(amount, bidButton);
    }
}

// Actual bid submission function
async function submitBid(amount, bidButton) {
    try {
        const langPrefix = window.location.pathname.split('/')[1];
        const res = await fetch(`/${langPrefix}/api/bids/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ productId, amount })
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(`${i18n.bidSuccess} ${data.newPrice}`, 'success');
            
            // Check if time was extended (anti-sniper)
            if (data.time_extended) {
                const extSeconds = data.extension_seconds || 10;
                showToast(`${i18n.timeExtended} ${extSeconds} ${i18n.second}ï¼`, 'info');
            }
            
            // Immediately update UI with new price
            const newPrice = data.newPrice || amount;
            const currentPriceEl = document.getElementById('current-price-display');
            if (currentPriceEl) {
                currentPriceEl.textContent = '$' + newPrice;
            }
            
            // Update bids count (now there's at least one bid)
            currentBidsCount++;
            
            const nextBidEl = document.getElementById('next-bid-amount');
            if (nextBidEl) {
                nextBidEl.textContent = (parseInt(newPrice) + bidIncrement);
            }
            
            // Also trigger full poll for bid history and updated end_time
            pollData();
            
            // Re-enable button after 1.5 seconds
            setTimeout(() => {
                bidButton.disabled = false;
            }, 1500);
        } else {
            showToast(data.message || i18n.bidFailed, 'error');
            bidButton.disabled = false;
        }
    } catch (e) {
        console.error(e);
        showToast(i18n.networkError, 'error');
        bidButton.disabled = false;
    }
}

async function pollData() {
    try {
        const langPrefix = window.location.pathname.split('/')[1];
        const res = await fetch(`/${langPrefix}/api/products/${productId}/poll/`);
        const data = await res.json();
        if (data.success) {
            // Update end_time if it changed (anti-sniper extension)
            const p = data.product;
            if (p.end_time) {
                // p.end_time is now expected to be an ISO 8601 string from views.py
                const newEndTime = p.end_time;
                
                if (newEndTime !== endTimeStr) {
                    console.log('â° End time changed from', endTimeStr, 'to', newEndTime);
                    endTimeStr = newEndTime;
                    // Immediately update countdown timer to reflect new end time
                    updateCountdown();
                }
            }
            
            // Update Price
            const currentPrice = p.current_price || p.start_price;
            
            // Update old element (if exists)
            const oldPriceEl = document.getElementById('current-price');
            if (oldPriceEl) {
                oldPriceEl.innerText = currentPrice;
            }
            
            // Update new UI elements for fixed-increment bidding
            const currentPriceDisplay = document.getElementById('current-price-display');
            if (currentPriceDisplay) {
                currentPriceDisplay.innerText = '$' + currentPrice;
            }
            
            const bidsCountEl = document.getElementById('bids-count');
            if (bidsCountEl) {
                bidsCountEl.innerText = p.bids_count || 0;
            }
            
            // Update current bids count for first bid logic
            currentBidsCount = p.bids_count || 0;
            
            // Update highest bidder (display employee ID, not name)
            const highestBidderEl = document.querySelector('[data-highest-bidder]');
            if (highestBidderEl) {
                if (data.highest_bidder && data.highest_bidder.id) {
                    // Display employee ID only
                    highestBidderEl.innerHTML = `<span class="text-blue-600 font-semibold">${data.highest_bidder.id}</span>`;
                } else {
                    highestBidderEl.innerText = '---';
                }
            }
            
            // Update next bid amount based on whether there are bids
            const nextBidEl = document.getElementById('next-bid-amount');
            if (nextBidEl) {
                if (currentBidsCount === 0) {
                    // First bid: show start price
                    nextBidEl.textContent = startPrice;
                } else {
                    // Subsequent bids: show current price + increment
                    nextBidEl.textContent = (parseInt(currentPrice) + bidIncrement);
                }
            }
            
            // Update List
            const list = document.getElementById('bids-list');
            list.innerHTML = '';
            if (data.bids && data.bids.length > 0) {
                data.bids.forEach(bid => {
                    const d = new Date(bid.bid_timestamp);
                    const dateStr = d.toLocaleString('zh-TW');
                    list.innerHTML += `<tr class="hover:bg-gray-50 transition border-b">
                        <td class="p-4 text-center font-medium text-gray-700">${bid.bidder_id}</td>
                        <td class="p-4 text-center font-medium text-gray-900">$${parseInt(bid.amount).toLocaleString()}</td>
                        <td class="p-4 text-center text-gray-500 text-sm">${dateStr}</td>
                    </tr>`;
                });
            } else {
                list.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-gray-400">${i18n.noBidsYet}</td></tr>`;
            }
        }
    } catch (e) {
        console.log('Poll failed', e);
    }
}

// Start polling with new system
document.addEventListener('DOMContentLoaded', () => {
    // Poll immediately and set up interval
    pollData();
    setInterval(pollData, REFRESH_INTERVAL);

    // Keep countdown timer
    setInterval(updateCountdown, 1000);
    updateCountdown();

    // Setup first-bid modal event listeners
    const confirmBtn = document.getElementById('confirmFirstBid');
    const cancelBtn = document.getElementById('cancelFirstBid');
    
    if (confirmBtn) {
        confirmBtn.addEventListener('click', async () => {
            hideFirstBidModal();
            if (pendingBidAmount !== null) {
                // Find the bid button
                const bidButton = document.querySelector('button[onclick="placeBid()"]');
                if (bidButton) {
                    bidButton.disabled = true;
                    await submitBid(pendingBidAmount, bidButton);
                }
                pendingBidAmount = null;
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            hideFirstBidModal();
            pendingBidAmount = null;
        });
    }

    console.log('âœ… Product detail page initialized with real-time polling');
});
</script>
{% endblock %}
