{% extends 'base.html' %}
{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <!-- Left: Image Section -->
        <div class="bg-gray-100 rounded-lg h-96 flex items-center justify-center text-gray-400 overflow-hidden">
            {% if product.image_url %}
                 <img src="{{ product.image_url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
            {% else %}
                 <span class="text-6xl">ğŸ“·</span>
            {% endif %}
        </div>

        <!-- Right: Info Section -->
        <div class="flex flex-col justify-between">
            <div>
                <div class="flex justify-between items-start mb-4">
                    <h1 class="text-3xl font-bold text-gray-900">{{ product.name }}</h1>
                    <span id="status-display" class="px-3 py-1 rounded-full text-sm font-medium
                        {% if product.status == 'Open' %}bg-green-100 text-green-800
                        {% elif product.status == 'Upcoming' %}bg-blue-100 text-blue-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ product.status }}
                    </span>
                </div>
                
                <div class="mb-6 space-y-2">
                    <p class="text-gray-600">å•†å“æè¿° (ç¯„ä¾‹): é€™æ˜¯ä¸€ä»¶éå¸¸ç¨€æœ‰çš„å•†å“ï¼Œè«‹æŠŠæ¡æ©Ÿæœƒã€‚</p>
                    <p class="text-sm text-gray-500">æˆªæ¨™æ™‚é–“: {{ product.end_time|slice:":10" }}</p>
                </div>

                <div class="bg-gray-50 p-6 rounded-lg border border-gray-100 mb-6">
                    <div class="text-sm text-gray-500 mb-1">ç›®å‰æœ€é«˜åƒ¹</div>
                    <div class="text-5xl font-mono font-bold text-red-600 mb-2">
                        NT$ <span id="current-price">{{ product.current_price|default:product.start_price }}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500">
                        <span>èµ·æ¨™: NT$ {{ product.start_price }}</span>
                        <span>å‡ºåƒ¹: <span id="bids-count">{{ product.bids_count|default:0 }}</span> æ¬¡</span>
                    </div>
                </div>
            </div>

            <!-- Action Section -->
            {% if employee %}
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">æ‚¨è¦å‡ºåƒ¹å¤šå°‘ï¼Ÿ</label>
                <div class="flex gap-2">
                    <input type="number" id="bid-amount" class="flex-1 border-2 border-gray-300 focus:border-blue-600 rounded px-4 py-2 outline-none text-lg" placeholder="è¼¸å…¥é‡‘é¡" />
                    <button onclick="placeBid()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-2 rounded font-bold text-lg transition shadow-md">
                        å‡ºåƒ¹
                    </button>
                </div>
                <p class="text-xs text-gray-500">æ³¨æ„ï¼šå‡ºåƒ¹å³ä¾¿è¦–ç‚ºå¥‘ç´„æˆç«‹ï¼Œç„¡æ³•å–æ¶ˆã€‚</p>
            </div>
            {% else %}
            <div class="bg-yellow-50 p-4 rounded text-center text-yellow-800 border border-yellow-200">
                è«‹å…ˆ <a href="{% url 'auctions:login' %}" class="underline font-bold hover:text-yellow-900">å“¡å·¥ç™»å…¥</a> åƒèˆ‡ç«¶æ¨™
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Bottom: History Section -->
    <div class="border-t pt-8">
        <h3 class="text-xl font-bold mb-4 text-gray-800">å‡ºåƒ¹æ­·å²è¨˜éŒ„ (æœ€æ–° 10 ç­†)</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-gray-600 text-sm uppercase">
                    <tr>
                        <th class="p-3">ç«¶æ¨™è€…</th>
                        <th class="p-3">é‡‘é¡</th>
                        <th class="p-3">æ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="bids-list" class="divide-y divide-gray-100">
                     <!-- Populated via JS -->
                     <tr><td colspan="3" class="p-4 text-center text-gray-500">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const productId = {{ product.id }};
const REFRESH_INTERVAL = 3000;

function showToast(message, type='info') {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    const colorClass = type === 'error' ? 'bg-red-500' : 'bg-green-500';
    el.className = `${colorClass} text-white px-4 py-2 rounded shadow mb-2 transition-opacity duration-300 opacity-0 transform translate-x-4`;
    el.innerText = message;
    container.appendChild(el);
    requestAnimationFrame(() => {
        el.classList.remove('opacity-0', 'translate-x-4');
    });
    setTimeout(() => {
        el.classList.add('opacity-0', 'translate-x-4');
        setTimeout(() => el.remove(), 300);
    }, 3000);
}

async function placeBid() {
    const amountInput = document.getElementById('bid-amount');
    const amount = amountInput.value;
    
    if (!amount) {
        showToast('è«‹è¼¸å…¥é‡‘é¡', 'error');
        return;
    }

    try {
        const res = await fetch('/place_bid/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Add csrf token if not strictly disabled or handled by cookie, but views.py uses @csrf_exempt for now or we rely on cookie
                // 'X-CSRFToken': getCookie('csrftoken') 
            },
            body: JSON.stringify({ productId, amount })
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(`å‡ºåƒ¹æˆåŠŸï¼ç›®å‰åƒ¹æ ¼ ${data.newPrice}`, 'success');
            amountInput.value = '';
            pollData(); // Refresh immediately
        } else {
            showToast(data.message || 'å‡ºåƒ¹å¤±æ•—', 'error');
        }
    } catch (e) {
        console.error(e);
        showToast('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦', 'error');
    }
}

async function pollData() {
    try {
        const res = await fetch(`/products/${productId}/poll/`);
        const data = await res.json();
        if (data.success) {
            // Update Price
            const p = data.product;
            document.getElementById('current-price').innerText = p.current_price || p.start_price;
            document.getElementById('bids-count').innerText = p.bids_count || 0;
            
            // Update List
            const list = document.getElementById('bids-list');
            list.innerHTML = '';
            if (data.bids && data.bids.length > 0) {
                data.bids.forEach(bid => {
                    // Simple formatting
                    const d = new Date(bid.bid_timestamp);
                    const dateStr = d.toLocaleString('zh-TW');
                    list.innerHTML += `<tr class="hover:bg-gray-50 transition">
                        <td class="p-3 font-medium text-gray-700">${bid.bidder_id}</td>
                        <td class="p-3 font-mono text-red-600 font-bold">NT$ ${bid.amount}</td>
                        <td class="p-3 text-gray-500 text-sm">${dateStr}</td>
                    </tr>`;
                });
            } else {
                list.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">ç›®å‰å°šç„¡å‡ºåƒ¹ï¼Œæˆç‚ºç¬¬ä¸€å€‹å‡ºåƒ¹è€…ï¼</td></tr>';
            }
        }
    } catch (e) {
        console.log('Poll failed', e);
    }
}

// Start polling
setInterval(pollData, REFRESH_INTERVAL);
pollData(); // Initial load
</script>
{% endblock %}
