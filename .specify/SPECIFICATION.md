# Kingsteel Auction - 公司內部二手義賣競標系統
## 完整系統規格書

**版本**：1.0  
**日期**：2025年12月8日  
**專案代號**：SDD-Auction-2025  
**目標受眾**：200位公司同仁  
**關鍵特性**：手機優先、一次性活動、即時同步、自動流標機制

---

## 一、專案概述

### 1.1 背景與目的
KINGSTEEL Auction 是一個公司內部二手義賣競標系統，為一次性活動設計，不對外公開。
目的是在一個簡單、有趣、透明的流程中，讓200位公司同仁透過手機Web介面參與單場拍賣活動。

### 1.2 核心目標
- ✅ 提供即時、流暢的拍賣體驗
- ✅ 確保流程透明、規則一致
- ✅ 支援自動化流標與結標機制
- ✅ 提供管理員後台管理工具
- ✅ 所有線上操作、線下結算

### 1.3 非目標（Out-of-Scope）
- ❌ 多場次拍賣管理
- ❌ 會員密碼登入系統
- ❌ 金流/物流整合
- ❌ 複雜通知系統（簡單頁面提示即可）

### 1.4 基本假設
- 200位同仁工號資訊已整理成JSON清單，存放於後端
- 拍賣期間網路環境相對穩定
- 使用者主要使用手機設備
- Admin通過環境變數進行身份驗證（不需複雜登入）

---

## 二、功能需求

### 2.1 使用者角色與權限

#### 2.1.1 Admin（管理員）
**身份驗證**
- 通過環境變數 `ADMIN_PASSWORD` 進行登入
- 登入頁面：輸入密碼 → 驗證成功 → 進入後台儀表板

**權限清單**
| 功能 | 描述 | 優先級 |
|------|------|--------|
| 新增拍賣品 | 輸入品名、起標價、圖片等資訊 | P0 |
| 編輯拍賣品 | 修改拍賣品資訊（拍賣未開始時） | P0 |
| 刪除拍賣品 | 刪除拍賣品（拍賣未開始時） | P1 |
| 設定拍賣時間 | 設定全場拍賣開始/結束時間 | P0 |
| 開始/結束拍賣 | 手動開始或結束拍賣 | P0 |
| 查看出價紀錄 | 列表/搜尋所有出價紀錄 | P0 |
| 查看拍賣商品詳情 | 包括當前價格、出價者、出價紀錄 | P0 |
| 手動降價（流標） | 手動應用降價規則 | P1 |
| 設定流標規則 | 自訂降價間隔和幅度 | P1 |
| 匯出報表 | 導出CSV (商品成交情況、出價紀錄) | P0 |
| 查看線上人數 | 即時在線人數統計 | P1 |

#### 2.1.2 User（公司同仁）
**身份驗證**
- 輸入工號 → 系統從JSON清單匹配 → 顯示姓名與部門 → 完成登入
- 無需密碼，工號即為身份識別
- 登入後可參與拍賣

**權限清單**
| 功能 | 描述 | 優先級 |
|------|------|--------|
| 查看拍賣品列表 | 以卡片形式展示所有拍賣品 | P0 |
| 查看商品詳情 | 商品資訊、圖片、當前價格、出價歷史 | P0 |
| 實時倒數計時 | 看到拍賣剩餘時間 | P0 |
| 出價 | 輸入價格 → 驗證 → 提交 | P0 |
| 查看個人出價歷史 | 我的出價記錄 | P0 |
| 查看得標結果 | 拍賣結束後看自己是否得標 | P0 |
| 推送通知（可選） | 得標/流標提醒 | P2 |

### 2.2 頁面結構與流程

#### 2.2.1 使用者流程圖

```
┌─────────────────────────────────────────────────────────┐
│                    User Flow                             │
└─────────────────────────────────────────────────────────┘

[首頁-登入頁]
    ↓
    └─→ 輸入工號 → 驗證 → 進入首頁
    
[首頁-拍賣品列表]
    ├─→ 查看所有拍賣品 (卡片展示)
    ├─→ 按狀態篩選 (進行中/未開始/已結束)
    ├─→ 查看商品基本資訊 (品名、圖片、當前價格、狀態)
    └─→ 點擊進入商品詳情頁

[商品詳情頁]
    ├─→ 完整商品資訊
    ├─→ 實時倒數計時
    ├─→ 當前最高價 & 最高出價者
    ├─→ 出價歷史列表
    ├─→ [出價按鈕] → 輸入價格 → 驗證 → 提交
    │   └─→ 驗證規則:
    │       ├─ 若有人出價，必須 > 目前最高價
    │       └─ 若無人出價，必須 ≥ 起標價
    │
    └─→ 返回列表

[個人中心/出價歷史]
    ├─→ 我的出價記錄（分頁展示）
    ├─→ 搜尋/篩選
    └─→ 查看得標狀態

[拍賣結束頁]
    ├─→ 若得標 → 顯示"恭喜得標！"
    ├─→ 若未得標 → 顯示"未得標"
    └─→ 查看最終成交價
```

#### 2.2.2 Admin 流程圖

```
┌─────────────────────────────────────────────────────────┐
│                  Admin Flow                              │
└─────────────────────────────────────────────────────────┘

[登入頁]
    ↓
    └─→ 輸入密碼 (ADMIN_PASSWORD) → 驗證 → 進入後台

[後台儀表板]
    ├─→ 統計資訊
    │   ├─ 總商品數
    │   ├─ 已成交商品數
    │   ├─ 流標商品數
    │   ├─ 參與出價人數
    │   └─ 目前在線人數
    │
    ├─→ 拍賣管理
    │   ├─ 設定拍賣開始/結束時間
    │   ├─ 開始拍賣按鈕
    │   ├─ 結束拍賣按鈕
    │   └─ 拍賣狀態顯示
    │
    ├─→ 商品管理
    │   ├─ 商品列表
    │   ├─ [新增商品] → 表單 → 保存
    │   ├─ [編輯商品] (限未開始)
    │   ├─ [刪除商品] (限未開始)
    │   └─ 查看商品詳情 + 出價歷史
    │
    ├─→ 出價管理
    │   ├─ 查看所有出價紀錄
    │   ├─ 按商品篩選
    │   ├─ 按出價者篩選
    │   ├─ 導出CSV
    │   └─ 刪除錯誤記錄 (可選)
    │
    └─→ 流標管理
        ├─ 查看流標商品
        ├─ 手動應用降價規則
        └─ 編輯流標規則設定
```

### 2.3 頁面詳細需求

#### 2.3.1 使用者端 - 首頁/登入
**URL**: `/`

**組件要素**:
- 如果未登入
  - 工號輸入框（文本框）
  - 驗證按鈕
  - 錯誤提示（工號不存在/網路錯誤）
  
- 如果已登入
  - 歡迎語（"歡迎，[姓名]"）
  - 登出按鈕
  - 拍賣狀態資訊（未開始/進行中/已結束）
  - 倒數計時（若進行中）

**響應式設計**:
- Mobile-first (< 480px): 單列佈局
- Tablet (480px - 1024px): 雙列卡片
- Desktop (> 1024px): 三列卡片

**流程邏輯**:
```
工號輸入 → 點擊驗證
    ↓
後端驗證工號格式 (4位數字)
    ↓
    ├─→ 工號存在 → 返回 {id, name, department}
    │    → 保存至 localStorage
    │    → 跳轉至商品列表
    │
    └─→ 工號不存在 → 顯示紅色錯誤訊息
```

#### 2.3.2 使用者端 - 拍賣品列表
**URL**: `/products`

**組件要素**:
- 頂部導航
  - 歡迎文字 & 登出按鈕
  - 個人中心連結
  
- 篩選區（可折疊）
  - 按狀態篩選：全部/進行中/未開始/已結束/流標
  - 搜尋框（品名搜尋）
  - 排序選項：新增時間/當前價格/剩餘時間
  
- 商品卡片網格
  ```
  ┌─────────────────┐
  │   [商品圖片]    │
  ├─────────────────┤
  │ 品名             │
  │ 起標價: 300元    │
  │ 目前價: 450元    │ (高亮顯示)
  │ 出價次數: 5次    │
  │ ⏱ 剩餘時間: 2h3m │
  │ 狀態: 進行中     │
  │ [查看詳情]       │
  └─────────────────┘
  ```
  - 點擊卡片 → 進入商品詳情頁
  
- 底部
  - 無限滾動 or 分頁（建議無限滾動）
  - 返回頂部按鈕

**資料結構**:
```json
{
  "id": "P001",
  "name": "二手辦公椅",
  "images": ["url/to/image1.jpg", "url/to/image2.jpg"],
  "startPrice": 300,
  "currentPrice": 450,
  "highestBidder": "張三",
  "bidsCount": 5,
  "status": "Active",
  "startTime": "2025-12-08T10:00:00Z",
  "endTime": "2025-12-08T12:00:00Z",
  "remainingSeconds": 7200
}
```

**備註**：圖片資料獨立存放於圖片資料夾，`images` 欄位為圖片 URL 陣列。文字資料與圖片資料分別由純文字資料庫與圖片資料夾管理。

#### 2.3.3 使用者端 - 商品詳情頁
**URL**: `/products/{productId}`

**上半部分 - 商品資訊**:
```
┌──────────────────────────────────────┐
│        [商品圖片-圖片輪播]            │
├──────────────────────────────────────┤
│ 品名: 二手辦公椅                      │
│ 品牌: Herman Miller                   │
│ 狀態: 進行中 🟢                       │
│ 起標價: ¥300                         │
│ 目前最高價: ¥450 ⬆️                  │
│ 出價次數: 5次                        │
│ 最高出價者: 張三 (採購部)             │
│ 結標倒數計時: 01:45:32 ⏱️             │
│ 商品描述:                            │
│ 狀況良好，有輪子和靠背調整功能      │
└──────────────────────────────────────┘
```

**中間部分 - 出價區域**:
```
┌──────────────────────────────────────┐
│ [出價區域] (僅在狀態=進行中時顯示)  │
│ 請輸入出價金額 (若有人出價則需 > 目前最高價；若無人出價則可等於或高於起標價) │
│ ┌──────────────────────────────────┐ │
│ │ [￥] [輸入框] 最多整數           │ │
│ └──────────────────────────────────┘ │
│ 快速出價:                           │
│ [+50] [+100] [+500] [+自訂]         │
│ [立即出價] [清除]                    │
└──────────────────────────────────────┘
```

**下半部分 - 出價紀錄**:
```
┌──────────────────────────────────────┐
│ 出價紀錄 (最新 10 筆，可分頁)        │
├──────────────────────────────────────┤
│ 1. 張三 (採購部)    ¥450  14:32:10   │
│ 2. 李四 (工程部)    ¥420  14:31:55   │
│ 3. 王五 (銷售部)    ¥380  14:30:22   │
│ ... (更多)                           │
│ [查看全部出價紀錄]                    │
└──────────────────────────────────────┘
```

**交互邏輯**:
```
使用者輸入出價金額
  ↓
前端驗證:
  ├─ 若有人出價則：金額必須 > 目前最高價
  ├─ 若無人出價則：金額必須 ≥ 起標價
  ├─ 金額必須是整數
  ├─ 金額 ≤ 999999
  └─ 拍賣狀態必須是 Active
    ↓
    ├─→ 驗證失敗 → 紅色提示訊息 + 震動回饋
    │
    └─→ 驗證成功 → 提交至後端
         ↓
         後端驗證 (double-check)
         ↓
         ├─→ 驗證失敗 → 返回錯誤
         │
         └─→ 驗證成功 → 保存至 DB
              → 返回 {success: true, newPrice, timestamp}
              → 前端更新UI
              → 顯示綠色成功提示 "出價成功！"
              → 自動滾動到最新出價紀錄
```

**實時更新**:
- 頁面每 2 秒自動 Polling 一次
- 獲取最新出價、結標倒數計時、商品狀態
- 若有新出價 → 刷新頁面資料
- 若時間到 → 自動跳轉到結果頁

#### 2.3.4 使用者端 - 個人中心
**URL**: `/profile`

**頁面佈局**:
```
┌──────────────────────────────────────┐
│ 個人資訊                              │
├──────────────────────────────────────┤
│ 工號: A001                           │
│ 姓名: 張三                           │
│ 部門: 採購部                         │
│ 登入時間: 2025-12-08 10:05:32       │
│ [登出] [返回首頁]                     │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ 我的出價紀錄                         │
├──────────────────────────────────────┤
│ [搜尋商品名] [按狀態篩選]             │
│                                      │
│ 1. 二手辦公椅                        │
│    出價: ¥450   時間: 14:32:10      │
│    狀態: 進行中 🟢                    │
│    [查看詳情]                        │
│                                      │
│ 2. 舊筆電                            │
│    出價: ¥2000  時間: 13:15:45      │
│    狀態: 已結標得標 ✅                │
│    [查看詳情]                        │
│                                      │
│ 3. 辦公檯燈                          │
│    出價: ¥150   時間: 11:22:30      │
│    狀態: 未得標 ❌                    │
│    [查看詳情]                        │
│                                      │
│ [第 1 頁 / 共 3 頁] [下一頁]        │
└──────────────────────────────────────┘
```

#### 2.3.5 Admin 後台 - 登入頁
**URL**: `/admin`

**簡單設計**:
```
┌──────────────────────────────────────┐
│                                      │
│   Kingsteel Auction                  │
│      管理員後台                      │
│                                      │
│ [密碼] [••••••]                      │
│                                      │
│     [登入]  [返回首頁]                │
│                                      │
└──────────────────────────────────────┘
```

**邏輯**:
```
輸入密碼 → 點擊登入
    ↓
驗證密碼是否等於 ADMIN_PASSWORD (環境變數)
    ↓
    ├─→ 正確 → localStorage.setItem('adminToken', token)
    │        → 跳轉到 /admin/dashboard
    │
    └─→ 錯誤 → 顯示紅色提示 "密碼錯誤"
```

#### 2.3.6 Admin 後台 - 儀表板
**URL**: `/admin/dashboard`

**頂部統計區**:
```
┌─────────────────────────────────────────────────────────┐
│ [< 返回首頁] KINGSTEEL Auction 管理後台 [登出]          │
├─────────────────────────────────────────────────────────┤
│ 統計資訊                                                │
├─────────────────────────────────────────────────────────┤
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐    │
│ │ 商品總數 │ │ 已成交   │ │ 流標商品 │ │ 在線人數 │    │
│ │    15    │ │    10    │ │    2     │ │    145   │    │
│ └──────────┘ └──────────┘ └──────────┘ └──────────┘    │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐                  │
│ │ 總成交額 │ │ 參與人數 │ │ 平均成交 │                  │
│ │ ¥25,500  │ │    120   │ │  ¥2,550  │                  │
│ └──────────┘ └──────────┘ └──────────┘                  │
└─────────────────────────────────────────────────────────┘
```

**拍賣管理區**:
```
┌─────────────────────────────────────────────────────────┐
│ 拍賣管理                                                │
├─────────────────────────────────────────────────────────┤
│ 拍賣狀態: 進行中 🟢                                     │
│ 開始時間: 2025-12-08 10:00:00                          │
│ 結束時間: 2025-12-08 16:00:00                          │
│ 剩餘時間: 3小時 25分 18秒                              │
│                                                        │
│ 設定開始時間: [日期時間選擇器]                          │
│ 設定結束時間: [日期時間選擇器]                          │
│                                                        │
│ [保存時間設定]  [開始拍賣]  [結束拍賣]  [重置]         │
└─────────────────────────────────────────────────────────┘
```

**導航菜單** (左側或頂部Tabs):
```
- 儀表板 (當前)
- 商品管理
- 出價紀錄
- 流標管理
- 設定
```

#### 2.3.7 Admin 後台 - 商品管理
**URL**: `/admin/products`

**商品列表**:
```
┌─────────────────────────────────────────────────────────┐
│ 商品管理                                                │
├─────────────────────────────────────────────────────────┤
│ [新增商品] [搜尋] [篩選狀態] [匯出]                      │
├─────────────────────────────────────────────────────────┤
│ # │ 品名         │ 起標   │ 目前   │ 出價 │ 狀態 │ 操作 │
│───┼──────────────┼────────┼────────┼──────┼──────┼──────┤
│1  │ 辦公椅       │ ¥300   │ ¥450   │ 5    │ 進行中 │ 詳情 │
│   │              │        │        │      │      │ 編輯 │
│   │              │        │        │      │      │ 刪除 │
├───┼──────────────┼────────┼────────┼──────┼──────┼──────┤
│2  │ 舊筆電       │ ¥2000  │ ¥2500  │ 3    │ 進行中 │ 詳情 │
│   │              │        │        │      │      │ 編輯 │
│   │              │        │        │      │      │ 刪除 │
└─────────────────────────────────────────────────────────┘
[分頁: 1 / 3]
```

**新增/編輯商品表單**:
```
┌─────────────────────────────────────────────────────────┐
│ 新增商品 / 編輯商品                                      │
├─────────────────────────────────────────────────────────┤
│ * 品名: [輸入框 - 例：二手辦公椅]                        │
│ * 起標價: [輸入框 - 必須 > 0]                            │
│   品牌: [輸入框 - 可選]                                  │
│   商品描述: [多行文本框]                                 │
│   圖片上傳: [上傳按鈕] 或 [圖片URL]                      │
│                                                        │
│ [保存] [取消]                                          │
└─────────────────────────────────────────────────────────┘

注意事項:
- 拍賣未開始時：可新增、編輯、刪除
- 拍賣已開始時：只能查看，不可編輯
- 刪除前需二次確認
```

#### 2.3.8 Admin 後台 - 出價紀錄
**URL**: `/admin/bids`

**列表展示**:
```
┌─────────────────────────────────────────────────────────┐
│ 出價紀錄                                                │
├─────────────────────────────────────────────────────────┤
│ [搜尋出價者] [按商品篩選] [匯出CSV] [清空篩選]           │
├─────────────────────────────────────────────────────────┤
│時間│商品│出價者│工號│部門│出價金額│結標│備註│        │
├────┼────┼──────┼────┼────┼────────┼────┼────┤        │
│14  │辦  │張三  │001 │採購│¥450    │ ✅  │ -  │        │
│:32 │公  │      │    │部  │        │    │    │        │
│:10 │椅  │      │    │    │        │    │    │        │
├────┼────┼──────┼────┼────┼────────┼────┼────┤        │
│14  │辦  │李四  │002 │工程│¥420    │ ❌  │未成│        │
│:31 │公  │      │    │部  │        │    │交  │        │
│:55 │椅  │      │    │    │        │    │    │        │
└────┴────┴──────┴────┴────┴────────┴────┴────┘        │
[分頁: 1 / 10] [導出為 CSV]
```

**匯出CSV格式**:
```
時間戳,商品ID,商品名,出價者,工號,部門,出價金額,結標狀態,備註
2025-12-08T14:32:10Z,P001,辦公椅,張三,0001,採購部,450,是,
2025-12-08T14:31:55Z,P001,辦公椅,李四,0002,工程部,420,否,
```

#### 2.3.9 Admin 後台 - 流標管理
**URL**: `/admin/unsold`

**流標商品列表**:
```
┌─────────────────────────────────────────────────────────┐
│ 流標管理                                                │
├─────────────────────────────────────────────────────────┤
│ 流標規則設定:                                           │
│ - 無人出價 0.5 小時 → 起標價 -10 元                     │
│ - 無人出價 1.0 小時 → 起標價 -20 元                     │
│ - ... 每 0.5 小時減 10 元，最低至 10 元                  │
│ [編輯規則] [應用規則]                                   │
├─────────────────────────────────────────────────────────┤
│ 流標商品:                                               │
│ 1. 品名: 辦公檯燈                                       │
│    起標價: ¥200 → 目前價: ¥180 (降價3次)               │
│    最後出價時間: 10:00:00                              │
│    時間已超: 6小時 20分                                │
│    狀態: 流標 ❌                                        │
│    [編輯] [標記已處理]                                  │
├─────────────────────────────────────────────────────────┤
│ 2. 品名: 鍵盤                                          │
│    ...
└─────────────────────────────────────────────────────────┘
```

### 2.4 核心業務邏輯

#### 2.4.1 出價規則
**出價的基本條件**:
```
使用者出價
    ↓
驗證:
    ├─ 拍賣狀態必須是 "Active"
    ├─ 出價金額必須是整數
    ├─ 出價金額 > 目前最高價
    │   (若無人出價過，則可以相同或更高)
    ├─ 出價金額 ≤ 999,999
    ├─ 同一使用者不能連續出價兩次
    │   (必須隔至少 1 秒，防止連點)
    └─ 出價者必須存在於員工清單中
    ↓
    ├─→ 驗證失敗 → 返回錯誤訊息，前端顯示
    │
    └─→ 驗證成功
         → 保存出價紀錄
         → 更新商品的 currentPrice & highestBidder
         → 記錄時間戳 (伺服器時間)
         → 返回成功並廣播給所有客戶端
```

**多人同時出價**:
- 若在同一時刻（毫秒級）收到多筆出價，伺服器按收到順序處理
- 只有最高出價者被記為 highestBidder
- 其他出價仍被記錄在紀錄中

**出價金額限制**:
```
若有人出過價:
  最小金額 = 目前最高價 + 1
else (無人出價):
  最小金額 = 起標價
最大金額 = 999,999
```

#### 2.4.2 時間控制
**拍賣流程時間軸**:
```
Upcoming (未開始)
    ↓ [時間到達 startTime]
Active (進行中)
    ├─ 每 2 秒檢查無人出價時間
    ├─ 若滿足降價條件 → 自動降價
    └─ [時間到達 endTime 或管理員手動結束]
         ↓
Ended (已結標)
    ├─ 計算得標者 (最高出價者)
    ├─ 更新商品狀態為 Sold or Unsold
    └─ [拍賣結束，流程完成]
```

**結標倒數計時**:
- 伺服器時間為唯一依據
- 使用者端每 2 秒從伺服器獲取最新時間
- 計算 remainingSeconds = endTime - 伺服器當前時間
- 顯示為 HH:MM:SS 格式

#### 2.4.3 流標規則
**何時觸發流標檢查**:
```
無人出價超過指定時間 → 自動降價（每 30 分鐘檢查）

時間軸:
最後出價 → +0.5h → 新起標價 = 原起標價 - 10 元
最後出價 → +1.0h → 新起標價 = 原起標價 - 20 元
最後出價 → +1.5h → 新起標價 = 原起標價 - 30 元
...
最後出價 → +Nh*0.5h → 新起標價 = 原起標價 - N*10 元

最低降價底線: 10 元（或依規則決定的最低價）
若新價格小於 原起標價 / 2 → 標記為「待撤標」(PendingWithdraw)，並立即通知 Admin。
Admin 在收到通知後有 1 小時的處理時限，期間 Admin 可執行動作：重新上架、手動調價、撤標或刪除。若 Admin 在 1 小時內未回應或未採取動作，系統將自動將商品標記為 `Unsold`（撤標）並結束拍賣。
```

**流標認定條件**:
```
若在最低起標價 (10 元) 或經過撤標條件觸發後，仍無人出價超過 1 小時，系統會標記為 `Unsold` 並結束拍賣。若商品被標記為 `PendingWithdraw`（因價格低於起標價一半）且 Admin 未在 1 小時內處理，系統同樣會自動將其標記為 `Unsold`。
```

**降價邏輯 (後端定時任務)**:
```
每分鐘或每 30 秒執行一次檢查（視系統資源），主流程如下：
for each 商品 in 進行中的商品:
  if 商品沒有人出過價:
    無出價時間 = 現在 - 商品開始時間
  else:
    無出價時間 = 現在 - 最後出價時間

  // 每 30 分鐘為一個降價單位
  應降幅度 = floor(無出價時間 / 1800 秒) * 10
  新起標價 = max(原起標價 - 應降幅度, 10)

  if 新起標價 < 舊起標價:
    更新商品起標價為 新起標價
    記錄降價日誌

  // 撤標條件：價格低於起標價的一半（選項 B：先進入待撤標階段，等待 Admin 決定）
  if 新起標價 < (原起標價 / 2):
    標記該商品為 PendingWithdraw
    記錄原因為 "Price fell below half of start price - pending admin decision"
    通知 Admin 檢視並決定後續（可重新上架、手動調價、撤標或刪除）
    設置 pending_until = 現在 + 3600 秒 (1 小時)
    // 在 pending 期間不立即結束拍賣；若 Admin 在時限內處理，依 Admin 指示執行；逾時自動撤標
    continue

  // 若已降至最低價且超過額外等待時間，則流標
  if 新起標價 == 10 且 無出價時間 > 3600 秒:
    標記該商品為 Unsold
    記錄降價/流標日誌
    拍賣狀態改為 "Ended"
```

#### 2.4.4 得標規則
**確定得標者**:
```
拍賣時間到 → 自動結標
    ↓
for each 商品:
    if 商品有人出過價:
        得標者 = highestBidder
        成交價 = currentPrice
        狀態 = "Sold"
    else:
        應用流標規則
        if 流標:
            狀態 = "Unsold"
        else:
            狀態 = "Active" (繼續等待)
```

**得標通知**:
- 拍賣結束後，每位使用者在個人中心可查看得標狀態
- 得標者看到 "恭喜得標，成交價為 ¥XXX，請於線下領取"
- 未得標者看到 "您未得標此商品"

---

## 三、技術需求

### 3.1 技術棧
| 層級 | 技術選擇 | 說明 |
|------|---------|------|
| 前端框架 | React + TypeScript | 快速開發、類型安全 |
| 狀態管理 | Zustand or Redux | 簡化狀態管理 |
| UI 框架 | Material-UI or Ant Design | 快速建構響應式 UI |
| 實時更新 | Polling (2秒) | 簡單可靠，無需 WebSocket |
| 後端框架 | Node.js + Express or NestJS | 快速開發、高效能 |
| 資料庫 | PostgreSQL or MongoDB | 可根據複雜度選擇 |
| 驗證 | JWT or Session | 簡單身份驗證 |
| 部署 | Docker + K8s or 傳統伺服器 | 可根據規模調整 |

### 3.2 API 設計

#### 3.2.1 認證接口
```
POST /api/auth/login
Body: { employeeId: string }
Response: 
  ├─ 成功: { success: true, name: string, department: string, token: string }
  └─ 失敗: { success: false, message: string }

POST /api/admin/login
Body: { password: string }
Response:
  ├─ 成功: { success: true, adminToken: string }
  └─ 失敗: { success: false, message: string }

POST /api/auth/logout
Response: { success: true }
```

#### 3.2.2 拍賣品接口
```
GET /api/products
Query: { status?: string, search?: string, sort?: string }
Response: 
  { 
    products: [
      {
        id: string,
        name: string,
        image: string,
        startPrice: number,
        currentPrice: number,
        highestBidder: { id: string, name: string },
        bidsCount: number,
        status: "Upcoming" | "Active" | "Ended" | "Unsold",
        startTime: ISO8601,
        endTime: ISO8601,
        remainingSeconds: number
      }
    ],
    total: number,
    page: number
  }

GET /api/products/:productId
Response:
  {
    id: string,
    name: string,
    image: string,
    brand: string,
    description: string,
    startPrice: number,
    currentPrice: number,
    highestBidder: { id, name, department },
    bidsCount: number,
    status: string,
    startTime: ISO8601,
    endTime: ISO8601,
    remainingSeconds: number,
    bidsHistory: [
      {
        id: string,
        bidder: { id, name, department },
        amount: number,
        timestamp: ISO8601
      }
    ]
  }

POST /api/admin/products
Body: { name, startPrice, brand?, description?, image? }
Response: { success: true, productId: string } or { success: false, message }

PUT /api/admin/products/:productId
Body: { name?, startPrice?, brand?, description?, image? }
Response: { success: true } or { success: false, message }

DELETE /api/admin/products/:productId
Response: { success: true } or { success: false, message }
```

#### 3.2.3 出價接口
```
POST /api/bids
Body: { productId: string, amount: number }
Response:
  ├─ 成功: { 
      success: true,
      bidId: string,
      newPrice: number,
      timestamp: ISO8601
    }
  └─ 失敗: { 
      success: false,
      message: string,
      errorCode: "INVALID_AMOUNT" | "AUCTION_CLOSED" | etc
    }

GET /api/my-bids
Query: { page?: number, productId?: string }
Response:
  {
    bids: [
      {
        id: string,
        productId: string,
        productName: string,
        amount: number,
        timestamp: ISO8601,
        isWinner: boolean,
        productStatus: string
      }
    ],
    total: number,
    page: number
  }

GET /api/admin/bids
Query: { page?: number, productId?: string, bidderId?: string }
Response:
  {
    bids: [
      {
        id: string,
        timestamp: ISO8601,
        productId: string,
        productName: string,
        bidderId: string,
        bidderName: string,
        bidderDepartment: string,
        amount: number,
        isWinning: boolean
      }
    ],
    total: number,
    page: number
  }

POST /api/admin/bids/export
Response: CSV file download
```

#### 3.2.4 拍賣管理接口
```
GET /api/auction/status
Response:
  {
    status: "Upcoming" | "Active" | "Ended",
    startTime: ISO8601,
    endTime: ISO8601,
    remainingSeconds: number,
    totalProducts: number,
    soldProducts: number,
    unsoldProducts: number,
    onlineUsers: number,
    totalBids: number
  }

POST /api/admin/auction/start
Body: { startTime: ISO8601, endTime: ISO8601 }
Response: { success: true } or { success: false, message }

POST /api/admin/auction/end
Response: { success: true } or { success: false, message }

PUT /api/admin/auction/settings
Body: { startTime?: ISO8601, endTime?: ISO8601, autoUnpricingRule?: {...} }
Response: { success: true } or { success: false, message }
```

### 3.3 資料庫設計

#### 3.3.1 核心表結構
```sql
-- 員工表 (初始化用，可從 JSON 匯入)
CREATE TABLE employees (
  id SERIAL PRIMARY KEY,
  employee_id VARCHAR(20) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  department VARCHAR(100) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 拍賣品表
CREATE TABLE products (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  start_price DECIMAL(10,2) NOT NULL,
  current_price DECIMAL(10,2) NOT NULL DEFAULT start_price,
  brand VARCHAR(100),
  description TEXT,
  image_url VARCHAR(500),
  status VARCHAR(20) DEFAULT 'Upcoming', -- Upcoming, Active, Ended, Unsold
  highest_bidder_id INT REFERENCES employees(id),
  bids_count INT DEFAULT 0,
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP NOT NULL,
  last_bid_time TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 出價記錄表
CREATE TABLE bids (
  id SERIAL PRIMARY KEY,
  product_id INT NOT NULL REFERENCES products(id),
  bidder_id INT NOT NULL REFERENCES employees(id),
  amount DECIMAL(10,2) NOT NULL,
  bid_timestamp TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_product_timestamp (product_id, bid_timestamp),
  INDEX idx_bidder (bidder_id)
);

-- 拍賣狀態表 (全局拍賣資訊)
CREATE TABLE auction_settings (
  id INT PRIMARY KEY DEFAULT 1,
  status VARCHAR(20) DEFAULT 'Upcoming',
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  auto_unpricing_interval INT DEFAULT 3600, -- 秒，1小時
  auto_unpricing_amount INT DEFAULT 10, -- 元
  min_price INT DEFAULT 10, -- 最低價
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);

-- 流標規則日誌表
CREATE TABLE unsold_logs (
  id SERIAL PRIMARY KEY,
  product_id INT NOT NULL REFERENCES products(id),
  reason VARCHAR(100),
  previous_price DECIMAL(10,2),
  new_price DECIMAL(10,2),
  log_timestamp TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.3.2 索引設計
```sql
-- 查詢優化
CREATE INDEX idx_product_status ON products(status);
CREATE INDEX idx_product_time ON products(start_time, end_time);
CREATE INDEX idx_bid_product_time ON bids(product_id, bid_timestamp DESC);
CREATE INDEX idx_bid_bidder ON bids(bidder_id);
```

### 3.4 性能與可擴展性

#### 3.4.1 性能指標
| 指標 | 目標值 |
|------|--------|
| 首頁加載 | < 2 秒 |
| 列表加載 | < 1 秒 |
| 出價提交 | < 500ms |
| 詳情頁加載 | < 1 秒 |
| 資料刷新 (Polling) | 2 秒 |
| 同時在線用戶 | 200+ |
| QPS (Query Per Second) | 200+ |

#### 3.4.2 優化策略
- **前端**：代碼分割、圖片懶加載、緩存、CDN
- **後端**：資料庫索引、查詢優化、API 緩存（Redis）、連接池
- **架構**：水平擴展、負載均衡、分佈式緩存

### 3.5 安全考量

#### 3.5.1 認證與授權
- 使用 JWT Token 或 Session 管理身份
- Admin 密碼存儲為環境變數，不硬編碼
- 前端檢查 token 有效性，過期則跳回登入

#### 3.5.2 資料驗證
- 後端必須驗證所有輸入（前端驗證僅為用戶體驗）
- 防止 SQL 注入：使用參數化查詢
- 防止 XSS：轉義用戶輸入

#### 3.5.3 業務邏輯驗證
- 每筆出價必須在後端重新驗證（不信任前端資料）
- 時間檢查：伺服器時間為唯一來源
- 避免競態條件：使用資料庫事務或鎖機制

#### 3.5.4 敏感資訊
- 不記錄或曝露員工密碼（不需要密碼）
- Admin 密碼不應出現在日誌中
- CSV 匯出時注意隱私（可選擇脫敏）

---

## 四、非功能性需求

### 4.1 可用性
- 響應式設計，支援 iPhone/Android/平板
- 所有按鈕大小 ≥ 44px，便於觸控
- 字體大小 ≥ 14px，易於閱讀
- 高對比度，符合 WCAG 2.1 AA 標準

### 4.2 可靠性
- 99.5% 可用性保證（在拍賣期間內）
- 掉線重連：若連線中斷，自動重新連接
- 資料備份：每小時備份一次
- 錯誤恢復：關鍵操作支援重試

### 4.3 可維護性
- 代碼遵循專案憲章規範
- 關鍵函數需有單元測試
- API 文檔需保持最新
- 部署流程需文檔化

### 4.4 可擴展性
- 模組化架構，便於添加新功能
- API 版本控制（如 /api/v1/）
- 易於支援多場拍賣（雖然當前不需要）

---

## 五、測試策略

### 5.1 單元測試
- 業務邏輯函數（出價驗證、流標規則等）：80% 覆蓋率
- 使用 Jest + React Testing Library (前端)
- 使用 Jest + Supertest (後端)

### 5.2 集成測試
- API 端到端測試
- 資料庫交互測試
- 流程整合測試（登入 → 出價 → 查詢結果）

### 5.3 功能測試
- 拍賣流程測試
- 流標規則測試
- 並發出價測試
- 時間到期自動結標測試

### 5.4 性能測試
- 負載測試：200 並發用戶
- 壓力測試：超載情況下的表現

### 5.5 用戶驗收測試 (UAT)
- 邀請實際員工參與測試
- 驗證流程符合需求
- 收集回饋並迭代

---

## 六、部署與運維

### 6.1 部署環境
- **開發環境**：本地或開發伺服器
- **測試環境**：與生產環境結構相同
- **生產環境**：雲端或公司伺服器

### 6.2 部署工具
- Docker 容器化
- CI/CD 管道（GitHub Actions or GitLab CI）
- 自動化測試 & 部署

### 6.3 配置管理
```env
# .env.example
ADMIN_PASSWORD=your_admin_password_here
DATABASE_URL=postgresql://user:password@host:5432/auction_db
NODE_ENV=production
PORT=3000
JWT_SECRET=your_secret_key_here
CORS_ORIGIN=https://auction.kingsteel.com
```

### 6.4 監控與告警
- 應用日誌：記錄關鍵事件
- 性能監控：API 響應時間、資料庫查詢
- 告警規則：
  - 伺服器宕機
  - 出價失敗率 > 1%
  - API 響應時間 > 1000ms

### 6.5 災難恢復
- 定期備份資料庫
- 恢復測試：每月進行一次恢復演練
- RTO：< 1 小時，RPO：< 5 分鐘

---

## 七、時程規劃

### 7.1 開發階段
| 階段 | 時間 | 說明 |
|------|------|------|
| 需求分析 & 設計 | 1週 | 完成規格書、原型設計、架構設計 |
| 後端開發 | 2週 | API 開發、資料庫設計、核心邏輯 |
| 前端開發 | 2週 | UI 實現、狀態管理、整合 API |
| 測試 & 優化 | 1週 | 單元/集成/功能測試、性能優化 |
| UAT & 回饋 | 1週 | 使用者測試、修復 bug、調整 |
| 部署 & 上線 | 3天 | 環境部署、最後驗證、上線 |

### 7.2 上線前檢查清單
- [ ] 所有功能已測試
- [ ] 性能指標達成
- [ ] 安全測試通過
- [ ] 文檔完整
- [ ] 備份與恢復機制就位
- [ ] 監控與告警配置完成
- [ ] 團隊培訓完成

---

## 八、成功標準

### 8.1 功能成功標準
- ✅ 所有在 Scope 功能都已實現
- ✅ 拍賣流程順利進行，無重大 bug
- ✅ 200 位員工能夠順利使用

### 8.2 性能成功標準
- ✅ 出價提交 < 500ms
- ✅ 支援 200+ 並發用戶
- ✅ 99.5% 可用性

### 8.3 用戶滿意度
- ✅ 員工回饋率 > 80%
- ✅ 功能完成度評分 > 4/5
- ✅ 系統易用性評分 > 4/5

---

## 九、風險與對策

| 風險 | 概率 | 影響 | 對策 |
|------|------|------|------|
| 網路不穩定 | 中 | 高 | 實現離線功能、重連機制、本地緩存 |
| 並發出價衝突 | 中 | 中 | 資料庫級鎖、樂觀鎖、事務控制 |
| 員工列表資訊不全 | 低 | 高 | 提前驗證資料、建立回饋機制 |
| 流標規則理解混亂 | 中 | 中 | 詳細文檔、頁面提示、FAQ |
| 上線時間緊張 | 中 | 高 | 提前規劃、使用既有元件、MVP 策略 |
| 資料安全/隱私洩露 | 低 | 極高 | 加密存儲、存取控制、定期安全審計 |

---

## 十、附錄

### 10.1 員工列表 JSON 格式
```json
[
  {
    "id": 1,
    "employeeId": "0001",
    "name": "張三",
    "department": "採購部"
  },
  {
    "id": 2,
    "employeeId": "0002",
    "name": "李四",
    "department": "工程部"
  },
  ...
]
```

### 10.2 API 錯誤碼定義
```json
{
  "SUCCESS": 200,
  "BAD_REQUEST": 400,
  "UNAUTHORIZED": 401,
  "FORBIDDEN": 403,
  "NOT_FOUND": 404,
  "CONFLICT": 409,
  "INVALID_BID_AMOUNT": 4001,
  "AUCTION_NOT_ACTIVE": 4002,
  "EMPLOYEE_NOT_FOUND": 4003,
  "PRODUCT_NOT_FOUND": 4004,
  "BID_TOO_FREQUENT": 4005,
  "INTERNAL_ERROR": 500
}
```

### 10.3 常見問題 (FAQ)
**Q: 多人同時出價怎麼辦？**  
A: 伺服器按收到順序處理，最後一筆為最高價。

**Q: 出價後能取消嗎？**  
A: 不能。出價後無法取消，但若有人出更高價，您的出價會被替換。

**Q: 商品流標後會怎樣？**  
A: 商品將被標記為流標，由公司決定是否重新上架或作其他處理。

**Q: 拍賣結束後如何領取？**  
A: 所有結算工作在線下進行，得標者將收到相關通知。

**Q: 為什麼我輸入與目前最高價相同的金額不能出價？**  
A: 系統要求出價必須高於目前最高價，以避免價格相同造成混淆。若無人出價，您可以以起標價或更高的價格出價。

### 10.4 術語表
| 術語 | 定義 |
|------|------|
| 起標價 | 商品的初始最低出價 |
| 出價 | 使用者提交的競標金額 |
| 得標 | 在結標時出價最高者 |
| 流標 | 在規定時間內無人出價導致商品不成交 |
| 結標 | 拍賣時間結束，自動停止出價 |
| Polling | 客戶端定時向伺服器查詢資料的方式 |
| Token | 身份驗證憑證 |
| CSV | 逗號分隔值，用於匯出資料 |

---

**文檔版本**：v1.0  
**最後更新**：2025年12月8日  
**維護者**：SDD 專案團隊  
**審查人**：管理層、技術負責人

---

## 變更日誌
| 版本 | 日期 | 變更說明 |
|------|------|---------|
| 1.0 | 2025-12-08 | 初版規格書發佈 |

---

**本規格書是項目開發的指導文檔，若有任何疑問或需要修改，請聯繫專案經理或技術負責人。**
